; ============================================
; PHP-FPM Configuration untuk Server 8 vCPU / 16GB RAM
; OPTIMIZED untuk 4 Aplikasi + Ratusan Concurrent Users
; ============================================

[www]
; ============================================
; PROCESS MANAGER SETTINGS
; ============================================

; Process Manager Strategy
; dynamic = adjust based on load (best untuk high traffic dengan variasi)
pm = dynamic

; Maximum number of child processes
; PERHITUNGAN:
; - 8 vCPU × 2-3 workers = 16-24 workers per vCPU
; - Untuk 4 aplikasi dengan ratusan users: butuh 80-100 workers
; - Memory: 16GB - 4GB (system) = 12GB available
; - Per process: ~100-150MB → 12GB / 120MB = ~100 workers max
; - Set ke 80 untuk safety margin
pm.max_children = 80

; Number of child processes created on startup
; Set ke 40% dari max_children untuk quick response tanpa waste
pm.start_servers = 32

; Minimum number of idle server processes
; Set ke 25% dari max_children untuk handle traffic spike
pm.min_spare_servers = 20

; Maximum number of idle server processes
; Set ke 50% dari max_children untuk handle traffic spike
pm.max_spare_servers = 40

; Number of requests each child process should execute before respawning
; Untuk production high traffic: 200-500 (reduce overhead restart)
; Set ke 200 untuk balance antara memory leak prevention dan performance
pm.max_requests = 200

; ============================================
; PROCESS IDLE TIMEOUT
; ============================================

; The number of seconds after which an idle process will be killed
; Increase untuk reduce overhead spawn/kill processes
; Set ke 30s untuk high traffic (process akan lebih lama idle sebelum di-kill)
pm.process_idle_timeout = 30s

; ============================================
; STATUS PAGE (Monitoring)
; ============================================

; Enable status page untuk monitoring
pm.status_path = /status

; ============================================
; PERFORMANCE TUNING
; ============================================

; The timeout for serving a single request
; Set ke 180s (3 menit) untuk handle heavy requests tapi tidak terlalu lama
request_terminate_timeout = 180s

; The timeout for reading request body
request_slowlog_timeout = 30s

; Log slow requests (requests > 30s)
slowlog = /var/log/php-fpm/www-slow.log

; ============================================
; SECURITY SETTINGS
; ============================================

; User dan Group untuk PHP-FPM processes
; Sesuaikan dengan user server Anda
user = ymsuperadmin
group = ymsuperadmin

; Listen socket
; Untuk cPanel biasanya: /var/cpanel/php/sockets/ymsuperadmin/php82.sock
; Atau: unix:/var/run/php-fpm/www.sock
listen = /var/cpanel/php/sockets/ymsuperadmin/php82.sock
; Atau jika pakai TCP: listen = 127.0.0.1:9000

; Listen owner dan group
listen.owner = ymsuperadmin
listen.group = ymsuperadmin
listen.mode = 0660

; ============================================
; ENVIRONMENT VARIABLES
; ============================================

; Clear environment variables
clear_env = no

; ============================================
; PHP INI SETTINGS (Override)
; ============================================

; Memory limit per process
; Reduce ke 128M untuk allow more workers
; Jika ada heavy process, bisa naikkan ke 192M
php_admin_value[memory_limit] = 128M

; Max execution time
php_admin_value[max_execution_time] = 180

; Max input time
php_admin_value[max_input_time] = 180

; Upload max filesize
php_admin_value[upload_max_filesize] = 64M

; Post max size
php_admin_value[post_max_size] = 64M

; Max input vars
php_admin_value[max_input_vars] = 5000

; ============================================
; OPcache SETTINGS (CRITICAL untuk Performance)
; ============================================

php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 512
php_admin_value[opcache.interned_strings_buffer] = 32
php_admin_value[opcache.max_accelerated_files] = 50000
php_admin_value[opcache.revalidate_freq] = 0
php_admin_value[opcache.validate_timestamps] = 0
php_admin_value[opcache.save_comments] = 1
php_admin_value[opcache.fast_shutdown] = 1
php_admin_value[opcache.enable_cli] = 0

; ============================================
; REALPATH CACHE (CRITICAL untuk Laravel)
; ============================================

php_admin_value[realpath_cache_size] = 16M
php_admin_value[realpath_cache_ttl] = 3600

; ============================================
; LOGGING
; ============================================

; Access log
access.log = /var/log/php-fpm/www-access.log
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"

; Error log
php_admin_value[error_log] = /var/log/php-fpm/www-error.log
php_admin_flag[log_errors] = on

; ============================================
; CATCH WORKERS OUTPUT
; ============================================

; Redirect worker stdout and stderr into main error log
catch_workers_output = yes
decorate_workers_output = no
