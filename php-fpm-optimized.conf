; ============================================
; PHP-FPM Configuration untuk Server 8 vCPU / 16GB RAM
; Optimized untuk High Traffic
; ============================================

[www]
; ============================================
; PROCESS MANAGER SETTINGS
; ============================================

; Process Manager Strategy
; static = fixed number of workers (best untuk server dedicated)
; dynamic = adjust based on load (best untuk shared server)
; ondemand = spawn on demand (best untuk low traffic)
pm = dynamic

; Maximum number of child processes
; Formula: (vCPU × 2) + 4 = (8 × 2) + 4 = 20
; Untuk high traffic, bisa naikkan ke 24-28
; JANGAN lebih dari 32 untuk 8 vCPU
pm.max_children = 24

; Number of child processes created on startup
; Set ke 50% dari max_children untuk quick response
pm.start_servers = 12

; Minimum number of idle server processes
; Set ke 30% dari max_children
pm.min_spare_servers = 8

; Maximum number of idle server processes
; Set ke 50% dari max_children
pm.max_spare_servers = 12

; Number of requests each child process should execute before respawning
; Lower value = prevent memory leaks, but more overhead
; Higher value = less overhead, but risk memory leaks
; Untuk production: 50-100 (restart setiap 50-100 requests)
pm.max_requests = 100

; ============================================
; PROCESS IDLE TIMEOUT
; ============================================

; The number of seconds after which an idle process will be killed
; Default: 10s (sudah baik)
pm.process_idle_timeout = 10s

; ============================================
; STATUS PAGE (Monitoring)
; ============================================

; Enable status page untuk monitoring
pm.status_path = /status

; ============================================
; PERFORMANCE TUNING
; ============================================

; The timeout for serving a single request
; Set ke 300s (5 menit) untuk handle heavy requests
request_terminate_timeout = 300s

; The timeout for reading request body
request_slowlog_timeout = 60s

; Log slow requests
slowlog = /var/log/php-fpm/www-slow.log

; ============================================
; SECURITY SETTINGS
; ============================================

; User dan Group untuk PHP-FPM processes
; Sesuaikan dengan user server Anda
user = ymsuperadmin
group = ymsuperadmin

; Listen socket
; Untuk cPanel biasanya: /var/cpanel/php/sockets/ymsuperadmin/php82.sock
; Atau: unix:/var/run/php-fpm/www.sock
listen = /var/cpanel/php/sockets/ymsuperadmin/php82.sock
; Atau jika pakai TCP: listen = 127.0.0.1:9000

; Listen owner dan group
listen.owner = ymsuperadmin
listen.group = ymsuperadmin
listen.mode = 0660

; ============================================
; ENVIRONMENT VARIABLES
; ============================================

; Clear environment variables
clear_env = no

; ============================================
; PHP INI SETTINGS (Override)
; ============================================

; Memory limit per process
php_admin_value[memory_limit] = 256M

; Max execution time
php_admin_value[max_execution_time] = 300

; Max input time
php_admin_value[max_input_time] = 300

; Upload max filesize
php_admin_value[upload_max_filesize] = 128M

; Post max size
php_admin_value[post_max_size] = 128M

; Max input vars
php_admin_value[max_input_vars] = 5000

; ============================================
; OPcache SETTINGS (jika belum di php.ini)
; ============================================

php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 256
php_admin_value[opcache.interned_strings_buffer] = 16
php_admin_value[opcache.max_accelerated_files] = 20000
php_admin_value[opcache.revalidate_freq] = 0
php_admin_value[opcache.validate_timestamps] = 0
php_admin_value[opcache.save_comments] = 1
php_admin_value[opcache.fast_shutdown] = 1

; ============================================
; LOGGING
; ============================================

; Access log
access.log = /var/log/php-fpm/www-access.log
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"

; Error log
php_admin_value[error_log] = /var/log/php-fpm/www-error.log
php_admin_flag[log_errors] = on

; ============================================
; CATCH WORKERS OUTPUT
; ============================================

; Redirect worker stdout and stderr into main error log
catch_workers_output = yes
decorate_workers_output = no

