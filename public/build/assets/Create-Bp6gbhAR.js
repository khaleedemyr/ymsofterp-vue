import{$ as ie,c as E,r as y,k as ae,A as L,B as r,C as re,D as t,E as b,L as u,G as p,O as ue,H as _,F as k,M as C,N as v,I as de,J as O,V as M,W as F}from"./vendor-vue-g7iCcTkf.js";import{A as ce}from"./AppLayout-BDukGJW2.js";import pe from"./CameraModal-UOq4SzNh.js";import"./vendor-utils-CpgP2uT4.js";import"./app-DGqVli5-.js";import"./vendor-charts-CuqD4wLC.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ProfileUpdateModal-CnwZ944E.js";import"./InputLabel-Bg0AMQZ3.js";import"./PrimaryButton-BbBAD9SX.js";import"./TextInput-B7P_xVe4.js";const me={class:"w-full min-h-screen py-8 px-2 md:px-6"},ge={class:"bg-white rounded-xl shadow-lg p-6 mb-6"},fe={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},be=["value"],ve=["value"],xe=["value"],he=["value"],ye={class:"bg-white rounded-xl shadow-lg p-6 mb-6"},_e={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},we={class:"flex items-center gap-3 cursor-pointer"},ke=["value"],Ce={class:"font-medium text-gray-800"},Se={key:0,class:"text-sm text-gray-600"},$e={key:0,class:"bg-white rounded-xl shadow-lg p-6 mb-6"},Oe={class:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4"},Be={class:"flex items-center justify-between"},Te={class:"flex items-center gap-3"},je={class:"text-lg font-semibold text-blue-800"},Ee={key:0,class:"flex items-center gap-2"},Fe={key:0,class:"text-yellow-600 text-sm flex items-center gap-1"},Ue={key:1,class:"text-green-600 text-sm flex items-center gap-1"},Pe={key:2,class:"text-red-600 text-sm flex items-center gap-1"},Ve={class:"flex items-center gap-2"},Ae=["onClick"],Ke=["onClick","disabled"],Le={key:0,class:"fa-solid fa-spinner fa-spin"},Me={key:1,class:"fa-solid fa-save"},Ne={class:"flex items-center justify-between mb-4"},De={class:"font-medium text-gray-700"},qe=["onClick"],Re={class:"space-y-4"},ze={class:"flex items-start gap-3 mb-3"},Ge=["id","onUpdate:modelValue"],Je=["for"],He={class:"font-medium text-gray-800"},We={key:0,class:"text-sm text-gray-600"},Xe={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ye=["onUpdate:modelValue"],Qe={class:"space-y-2"},Ze={class:"flex gap-2"},Ie=["onClick"],et=["onClick"],tt=["data-file-input","onChange"],st={key:0,class:"flex gap-2 flex-wrap"},ot=["src","alt","onClick"],nt=["onClick"],lt={class:"bg-white rounded-xl shadow-lg p-6 mb-6"},it={class:"flex justify-end gap-4"},at=["disabled"],rt={class:"relative max-w-4xl max-h-full p-4"},ut=["src","alt"],dt={key:0,class:"absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2"},ct={class:"bg-white bg-opacity-20 text-white px-3 py-1 rounded"},kt={__name:"Create",props:{outlets:Array,subjects:Array,user:Object},setup(B){const m=B,N=ie();E(()=>N.props.auth.user);const D=E(()=>{var o;return m.user&&(o=m.user.jabatan)!=null&&o.nama_jabatan?m.user.jabatan.nama_jabatan:"Staff"}),q=E(()=>{var o;return m.user&&(o=m.user.divisi)!=null&&o.nama_divisi?m.user.divisi.nama_divisi:"General"});y(!1);const g=y({}),l=ae({outlet_id:"",inspection_date:new Date().toISOString().split("T")[0],selected_subjects:[],general_notes:"",outlet_leader:"",details:{},subject_instances:{},saved_subjects:{}}),R=()=>{m.user},T=y(!1),U=y("photo"),S=y(null),j=y(!1),w=y([]),x=y(0),z=()=>{m.subjects.forEach(o=>{l.details[o.id]||(l.details[o.id]={}),l.subject_instances[o.id]||(l.subject_instances[o.id]=[0])})},$=o=>{const e=m.subjects.find(i=>i.id===o);return e?e.name:"Unknown Subject"},G=o=>{const e=m.subjects.find(i=>i.id===o);return e?e.active_items:[]},P=o=>l.subject_instances[o]||[0],J=o=>{l.subject_instances[o]||(l.subject_instances[o]=[0]);const e=l.subject_instances[o].length;l.subject_instances[o].push(e)},H=(o,e)=>{l.subject_instances[o].splice(e,1),l.details[o]&&Object.keys(l.details[o]).forEach(i=>{i.includes(`_${e}_`)&&delete l.details[o][i]})},f=(o,e,i)=>{const s=`${o}_${e}_${i}`;return l.details[o]||(l.details[o]={}),l.details[o][s]||(l.details[o][s]={subject_id:o,item_id:i,is_checked:!1,notes:"",documentation:[],documentation_preview:[]}),l.details[o][s]},W=(o,e,i)=>{S.value={subjectId:o,instanceIndex:e,itemId:i},U.value="photo",T.value=!0},X=(o,e,i)=>{console.log("Opening file upload for:",o,e,i);const s=document.querySelector(`input[data-file-input="${o}-${e}-${i}"]`);console.log("File input found:",s),s?s.click():console.error("File input not found for:",`${o}-${e}-${i}`)},Y=o=>{if(S.value){const{subjectId:e,instanceIndex:i,itemId:s}=S.value,d=f(e,i,s),n=se(o,`camera-capture-${Date.now()}.jpg`);d.documentation.push(n),d.documentation_preview.push({file:n,preview:o})}V()},V=()=>{T.value=!1,S.value=null},Q=(o,e,i,s)=>{const d=Array.from(o.target.files),n=f(e,i,s);d.forEach(a=>{if(a.type.startsWith("image/")){const c=new FileReader;c.onload=h=>{n.documentation.push(a),n.documentation_preview.push({file:a,preview:h.target.result})},c.readAsDataURL(a)}}),o.target.value=""},Z=(o,e,i,s)=>{const d=f(o,e,i);d.documentation.splice(s,1),d.documentation_preview.splice(s,1)},I=(o,e)=>{w.value=o,x.value=e,j.value=!0},A=()=>{j.value=!1,w.value=[],x.value=0},ee=()=>{x.value>0&&x.value--},te=()=>{x.value<w.value.length-1&&x.value++},se=(o,e)=>{const i=o.split(","),s=i[0].match(/:(.*?);/)[1],d=atob(i[1]);let n=d.length;const a=new Uint8Array(n);for(;n--;)a[n]=d.charCodeAt(n);return new File([a],e,{type:s})},oe=async o=>{if(!l.outlet_id){Swal.fire({title:"Peringatan!",text:"Pilih outlet terlebih dahulu!",icon:"warning",confirmButtonText:"OK"});return}if(!l.inspection_date){Swal.fire({title:"Peringatan!",text:"Pilih tanggal inspection terlebih dahulu!",icon:"warning",confirmButtonText:"OK"});return}g.value[o]="saving";try{const e=new FormData;e.append("outlet_id",l.outlet_id),e.append("inspection_date",l.inspection_date),e.append("general_notes",l.general_notes||""),e.append("outlet_leader",l.outlet_leader||""),e.append("subject_id",o);const i=[],s=l.details[o];if(s&&Object.values(s).forEach(n=>{(n.is_checked||n.notes||n.documentation&&n.documentation.length>0)&&i.push({subject_id:n.subject_id,item_id:n.item_id,is_checked:n.is_checked,notes:n.notes||"",documentation:n.documentation||[]})}),i.length===0){Swal.fire({title:"Peringatan!",text:"Tidak ada data untuk disimpan pada subject ini!",icon:"warning",confirmButtonText:"OK"}),g.value[o]="error";return}e.append("details",JSON.stringify(i)),i.forEach((n,a)=>{n.documentation&&n.documentation.length>0&&n.documentation.forEach((c,h)=>{c instanceof File&&e.append(`details[${a}][documentation][${h}]`,c)})}),console.log("Saving subject:",o,"with details:",i);const d=await fetch(route("dynamic-inspections.store-subject"),{method:"POST",body:e,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}});if(d.ok){const n=await d.json();g.value[o]="saved",l.saved_subjects[o]=n.inspection_id,Swal.fire({title:"Berhasil!",text:`Subject "${$(o)}" berhasil disimpan!`,icon:"success",timer:2e3,timerProgressBar:!0,showConfirmButton:!1})}else{const n=await d.json();g.value[o]="error",Swal.fire({title:"Error!",text:`Error saving subject: ${n.message||"Unknown error"}`,icon:"error",confirmButtonText:"OK"})}}catch(e){console.error("Error saving subject:",e),g.value[o]="error",Swal.fire({title:"Error!",text:"Terjadi kesalahan saat menyimpan subject!",icon:"error",confirmButtonText:"OK"})}},K=async()=>{if(l.selected_subjects.length===0){Swal.fire({title:"Peringatan!",text:"Pilih minimal satu subject untuk inspection!",icon:"warning",confirmButtonText:"OK"});return}const o=l.selected_subjects.filter(i=>!l.saved_subjects[i]);if(o.length>0){const i=o.map(s=>$(s)).join(", ");Swal.fire({title:"Konfirmasi",text:`Masih ada subject yang belum disimpan: ${i}. Lanjutkan?`,icon:"question",showCancelButton:!0,confirmButtonText:"Ya, Lanjutkan",cancelButtonText:"Batal"}).then(s=>{s.isConfirmed&&F.visit(route("dynamic-inspections.index"))});return}const e=Object.values(l.saved_subjects)[0];if(e)try{const i=await fetch(route("dynamic-inspections.complete",e),{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/json"}});if(i.ok){const s=await i.json();Swal.fire({title:"Berhasil!",text:s.message,icon:"success",timer:2e3,timerProgressBar:!0,showConfirmButton:!1}).then(()=>{F.visit(route("dynamic-inspections.index"))})}else{const s=await i.json();Swal.fire({title:"Error!",text:s.error||"Gagal menyelesaikan inspection!",icon:"error",confirmButtonText:"OK"})}}catch(i){console.error("Error completing inspection:",i),Swal.fire({title:"Error!",text:"Terjadi kesalahan saat menyelesaikan inspection!",icon:"error",confirmButtonText:"OK"})}else F.visit(route("dynamic-inspections.index"))};return z(),R(),(o,e)=>(r(),L(ce,null,{default:re(()=>{var i;return[t("div",me,[e[31]||(e[31]=t("h1",{class:"text-3xl font-bold mb-8 text-blue-800 flex items-center gap-3"},[t("i",{class:"fa-solid fa-clipboard-check text-blue-500"}),p(" Outlet/HO Inspection Form ")],-1)),t("form",{onSubmit:ue(K,["prevent"]),class:"max-w-6xl mx-auto"},[t("div",ge,[e[13]||(e[13]=t("h2",{class:"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"},[t("i",{class:"fa-solid fa-info-circle text-blue-600"}),p(" Inspection Information ")],-1)),t("div",fe,[t("div",null,[e[7]||(e[7]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Unit/Outlet *",-1)),_(t("select",{"onUpdate:modelValue":e[0]||(e[0]=s=>l.outlet_id=s),class:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:""},[e[6]||(e[6]=t("option",{value:""},"Pilih Outlet",-1)),(r(!0),u(k,null,C(B.outlets,s=>(r(),u("option",{key:s.id_outlet,value:s.id_outlet},v(s.nama_outlet),9,be))),128))],512),[[de,l.outlet_id]])]),t("div",null,[e[8]||(e[8]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Hari/Tanggal *",-1)),_(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>l.inspection_date=s),type:"date",class:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:""},null,512),[[O,l.inspection_date]])]),t("div",null,[e[9]||(e[9]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Nama PIC",-1)),t("input",{value:((i=m.user)==null?void 0:i.nama_lengkap)||"",disabled:"",class:"w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100"},null,8,ve)]),t("div",null,[e[10]||(e[10]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Jabatan",-1)),t("input",{value:D.value,disabled:"",class:"w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100"},null,8,xe)]),t("div",null,[e[11]||(e[11]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Divisi",-1)),t("input",{value:q.value,disabled:"",class:"w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100"},null,8,he)]),t("div",null,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Outlet Leader",-1)),_(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>l.outlet_leader=s),type:"text",class:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Masukkan nama Outlet Leader"},null,512),[[O,l.outlet_leader]])])])]),t("div",ye,[e[14]||(e[14]=t("h2",{class:"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"},[t("i",{class:"fa-solid fa-list-check text-blue-600"}),p(" Pilih Subject Inspection ")],-1)),t("div",_e,[(r(!0),u(k,null,C(B.subjects,s=>(r(),u("div",{key:s.id,class:"border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition"},[t("label",we,[_(t("input",{type:"checkbox",value:s.id,"onUpdate:modelValue":e[3]||(e[3]=d=>l.selected_subjects=d),class:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"},null,8,ke),[[M,l.selected_subjects]]),t("div",null,[t("div",Ce,v(s.name),1),s.description?(r(),u("div",Se,v(s.description),1)):b("",!0)])])]))),128))])]),l.selected_subjects.length>0?(r(),u("div",$e,[e[25]||(e[25]=t("h2",{class:"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"},[t("i",{class:"fa-solid fa-clipboard-list text-blue-600"}),p(" Inspection Details ")],-1)),(r(!0),u(k,null,C(l.selected_subjects,s=>(r(),u("div",{key:s,class:"mb-8"},[t("div",Oe,[t("div",Be,[t("div",Te,[t("h3",je,v($(s)),1),g.value[s]?(r(),u("div",Ee,[g.value[s]==="saving"?(r(),u("span",Fe,e[15]||(e[15]=[t("i",{class:"fa-solid fa-spinner fa-spin"},null,-1),p(" Saving... ")]))):g.value[s]==="saved"?(r(),u("span",Ue,e[16]||(e[16]=[t("i",{class:"fa-solid fa-check-circle"},null,-1),p(" Saved ")]))):g.value[s]==="error"?(r(),u("span",Pe,e[17]||(e[17]=[t("i",{class:"fa-solid fa-exclamation-circle"},null,-1),p(" Error ")]))):b("",!0)])):b("",!0)]),t("div",Ve,[t("button",{type:"button",onClick:d=>J(s),class:"px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition flex items-center gap-1"},e[18]||(e[18]=[t("i",{class:"fa-solid fa-plus"},null,-1),p(" Add More ")]),8,Ae),t("button",{type:"button",onClick:d=>oe(s),disabled:g.value[s]==="saving",class:"px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-1"},[g.value[s]==="saving"?(r(),u("i",Le)):(r(),u("i",Me)),e[19]||(e[19]=p(" Save Subject "))],8,Ke)])])]),(r(!0),u(k,null,C(P(s),(d,n)=>(r(),u("div",{key:n,class:"mb-6 border border-gray-200 rounded-lg p-4"},[t("div",Ne,[t("h4",De,v($(s))+" #"+v(n+1),1),P(s).length>1?(r(),u("button",{key:0,type:"button",onClick:a=>H(s,n),class:"text-red-600 hover:text-red-800 transition"},e[20]||(e[20]=[t("i",{class:"fa-solid fa-trash"},null,-1)]),8,qe)):b("",!0)]),t("div",Re,[(r(!0),u(k,null,C(G(s),a=>(r(),u("div",{key:a.id,class:"border border-gray-200 rounded-lg p-4"},[t("div",ze,[_(t("input",{type:"checkbox",id:`item-${s}-${n}-${a.id}`,"onUpdate:modelValue":c=>f(s,n,a.id).is_checked=c,class:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1"},null,8,Ge),[[M,f(s,n,a.id).is_checked]]),t("label",{for:`item-${s}-${n}-${a.id}`,class:"flex-1 cursor-pointer"},[t("div",He,v(a.name),1),a.description?(r(),u("div",We,v(a.description),1)):b("",!0)],8,Je)]),t("div",Xe,[t("div",null,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Notes",-1)),_(t("textarea",{"onUpdate:modelValue":c=>f(s,n,a.id).notes=c,rows:"2",class:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Tambahkan catatan..."},null,8,Ye),[[O,f(s,n,a.id).notes]])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Dokumentasi",-1)),t("div",Qe,[t("div",Ze,[t("button",{type:"button",onClick:c=>W(s,n,a.id),class:"px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition flex items-center gap-1"},e[22]||(e[22]=[t("i",{class:"fa-solid fa-camera"},null,-1),p(" Camera ")]),8,Ie),t("button",{type:"button",onClick:c=>X(s,n,a.id),class:"px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition flex items-center gap-1"},e[23]||(e[23]=[t("i",{class:"fa-solid fa-upload"},null,-1),p(" Upload ")]),8,et)]),t("input",{"data-file-input":`${s}-${n}-${a.id}`,type:"file",multiple:"",accept:"image/*",onChange:c=>Q(c,s,n,a.id),class:"hidden"},null,40,tt),f(s,n,a.id).documentation_preview.length>0?(r(),u("div",st,[(r(!0),u(k,null,C(f(s,n,a.id).documentation_preview,(c,h)=>(r(),u("div",{key:h,class:"relative group"},[t("img",{src:c.preview,alt:`Preview ${h+1}`,class:"w-20 h-20 object-cover rounded-lg border border-gray-200 cursor-pointer hover:shadow-lg transition",onClick:ne=>I(f(s,n,a.id).documentation_preview.map(le=>le.preview),h)},null,8,ot),t("button",{type:"button",onClick:ne=>Z(s,n,a.id,h),class:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition"}," Ã— ",8,nt)]))),128))])):b("",!0)])])])]))),128))])]))),128))]))),128))])):b("",!0),t("div",lt,[e[26]||(e[26]=t("h2",{class:"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"},[t("i",{class:"fa-solid fa-comment-dots text-blue-600"}),p(" Catatan/Komentar ")],-1)),_(t("textarea",{"onUpdate:modelValue":e[4]||(e[4]=s=>l.general_notes=s),rows:"4",class:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Tambahkan catatan umum tentang inspection..."},null,512),[[O,l.general_notes]])]),t("div",it,[t("button",{type:"button",onClick:e[5]||(e[5]=s=>o.$inertia.visit(o.route("dynamic-inspections.index"))),class:"px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition"}," Batal "),t("button",{type:"button",onClick:K,disabled:l.selected_subjects.length===0,class:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2"},e[27]||(e[27]=[t("i",{class:"fa-solid fa-check"},null,-1),p(" Selesai ")]),8,at)])],32),T.value?(r(),L(pe,{key:0,mode:U.value,onClose:V,onCapture:Y},null,8,["mode"])):b("",!0),j.value?(r(),u("div",{key:1,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75",onClick:A},[t("div",rt,[t("button",{onClick:A,class:"absolute top-4 right-4 text-white text-2xl hover:text-gray-300 z-10"},e[28]||(e[28]=[t("i",{class:"fa-solid fa-times"},null,-1)])),t("img",{src:w.value[x.value],alt:`Image ${x.value+1}`,class:"max-w-full max-h-full object-contain"},null,8,ut),w.value.length>1?(r(),u("div",dt,[t("button",{onClick:ee,class:"bg-white bg-opacity-20 text-white px-3 py-1 rounded hover:bg-opacity-30"},e[29]||(e[29]=[t("i",{class:"fa-solid fa-chevron-left"},null,-1)])),t("span",ct,v(x.value+1)+" / "+v(w.value.length),1),t("button",{onClick:te,class:"bg-white bg-opacity-20 text-white px-3 py-1 rounded hover:bg-opacity-30"},e[30]||(e[30]=[t("i",{class:"fa-solid fa-chevron-right"},null,-1)]))])):b("",!0)])])):b("",!0)])]}),_:1}))}};export{kt as default};
