import{r as m,$ as ne,a as le,j as re,c as ie,L as n,B as o,A as E,x as y,E as f,T as z,D as t,C as k,Q as g,F as C,M as $,N as x,H as de,J as ue,G as F,l as ce}from"./vendor-vue-g7iCcTkf.js";import me from"./CameraModal-UOq4SzNh.js";import{a as U}from"./vendor-utils-CpgP2uT4.js";import{S as p}from"./app-_bo91XrJ.js";import{_ as fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{Y as pe,h as R,_ as ve,G as ge,S as xe}from"./vendor-ui-CrPgGUUb.js";import"./vendor-charts-CuqD4wLC.js";const ye={key:0,class:"fixed inset-0 z-[99999] flex items-center justify-center"},he={class:"relative w-full max-w-5xl bg-white rounded-2xl p-6 shadow-xl mx-4"},ke={key:0,class:"flex justify-center"},be=["src"],we={key:1,class:"flex justify-center"},_e=["src"],Ce={class:"fixed inset-0 overflow-y-auto"},Ie={class:"flex min-h-full items-center justify-center p-4"},Se={class:"flex justify-between items-center mb-4"},je={class:"space-y-4 max-h-[500px] overflow-y-auto mb-4 pr-2"},De={key:0,class:"text-center py-4"},Me={key:1,class:"text-center py-4"},Be={class:"flex items-start gap-3"},Te={class:"w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white"},Ee={class:"flex-1"},$e={class:"flex justify-between items-start"},Fe={class:"font-medium text-gray-900"},Ue={class:"text-xs text-gray-500 ml-2"},Le=["onClick"],Ae={class:"text-gray-700 mt-1 text-base"},Ne={key:0,class:"mt-3 flex flex-wrap gap-3"},Ke=["onClick"],Oe=["src"],ze={key:1,class:"w-40 h-32 rounded-lg bg-gray-100 flex items-center justify-center relative group hover:bg-gray-200 transition-all border shadow-sm hover:shadow-md"},Re=["src"],We={key:2,class:"w-40 h-32 rounded-lg bg-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-200 transition-all border shadow-sm hover:shadow-md"},qe={class:"text-xs text-gray-600 px-2 text-center"},Ge={class:"border-t pt-4"},Ve={key:0,class:"text-xs text-gray-500 mb-3 flex items-center gap-2"},Ye={key:1,class:"flex flex-wrap gap-3 mb-3"},Pe=["src"],Je=["src"],He={key:2,class:"w-40 h-32 rounded-lg bg-gray-100 flex flex-col items-center justify-center gap-2 border shadow-sm"},Qe={class:"text-xs text-gray-600 px-2 text-center"},Xe=["onClick"],Ze={class:"flex justify-between items-center"},et={class:"flex gap-3"},tt=["disabled"],at={key:0,class:"fas fa-spinner fa-spin"},st={__name:"CommentModal",props:{taskId:{type:[Number,String],required:!0}},emits:["close","comment-added"],setup(W,{emit:q}){var O;const d=W,h=q,I=m([]),u=m(""),i=m([]),b=m(!1),S=m("photo"),v=m(!1),j=m(!1),G=((O=ne().props.auth)==null?void 0:O.user)||{},D=m(!1),w=m(""),_=m(""),M=async()=>{if(!d.taskId){console.error("fetchComments: No taskId provided");return}console.log("Fetching comments for taskId:",d.taskId),j.value=!0;try{const a=await U.get(`/api/maintenance-comments/${d.taskId}`);console.log("Comments fetched successfully:",a.data),I.value=a.data}catch(a){console.error("Error fetching comments:",a)}finally{j.value=!1}};function L(a){(a.ctrlKey||a.metaKey)&&a.key==="Enter"&&(a.preventDefault(),N()),a.key==="Escape"&&h("close")}function V(){(u.value.trim()||i.value.length>0)&&localStorage.setItem(`comment_draft_${d.taskId}`,JSON.stringify({comment:u.value,timestamp:Date.now()}))}function Y(){try{const a=localStorage.getItem(`comment_draft_${d.taskId}`);if(a){const e=JSON.parse(a);Date.now()-e.timestamp<36e5?u.value=e.comment:localStorage.removeItem(`comment_draft_${d.taskId}`)}}catch(a){console.error("Error loading draft:",a)}}function P(){localStorage.removeItem(`comment_draft_${d.taskId}`)}le(()=>{if(console.log("CommentModal mounted with taskId:",d.taskId),!d.taskId){console.error("CommentModal: No taskId provided"),p.fire({title:"Error",text:"Task ID tidak valid. Silakan coba lagi.",icon:"error"}),h("close");return}M(),Y(),document.addEventListener("keydown",L)}),re(()=>{document.removeEventListener("keydown",L)});const B=ie(()=>u.value.trim()!==""||i.value.length>0);function J(a){return a?a.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2):"NA"}function H(a){const e=new Date(a);return new Intl.DateTimeFormat("id-ID",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(e)}function A(a){S.value=a,b.value=!0}function Q(){b.value=!1}function X(a){S.value==="photo"?i.value.push({file:te(a,"photo.png"),preview:a,type:"image/png"}):i.value.push({file:new File([a],"video.webm",{type:"video/webm"}),preview:URL.createObjectURL(a),type:"video/webm"}),b.value=!1}function Z(a){Array.from(a.target.files).forEach(s=>{i.value.push({file:s,preview:s.type.startsWith("image/")?URL.createObjectURL(s):null,type:s.type})}),a.target.value=""}function ee(a){const e=i.value[a];e.preview&&!e.preview.startsWith("data:")&&URL.revokeObjectURL(e.preview),i.value.splice(a,1)}function te(a,e){const s=a.split(","),l=s[0].match(/:(.*?);/)[1],r=atob(s[1]);let c=r.length;const T=new Uint8Array(c);for(;c--;)T[c]=r.charCodeAt(c);return new File([T],e,{type:l})}async function N(){var a,e,s;if(B.value&&!v.value){if(!d.taskId){p.fire({title:"Error",text:"Task ID tidak valid. Silakan coba lagi.",icon:"error"});return}if(!(!u.value.trim()&&i.value.length>0&&!(await p.fire({title:"Konfirmasi",text:"Anda tidak menulis komentar. Apakah Anda yakin ingin mengirim hanya file saja?",icon:"question",showCancelButton:!0,confirmButtonText:"Ya, kirim file",cancelButtonText:"Tulis komentar dulu"})).isConfirmed)){v.value=!0;try{const l=new FormData;l.append("task_id",d.taskId),l.append("comment",u.value||"File attachment only"),i.value.forEach((c,T)=>{l.append("attachments[]",c.file)}),(await U.post("/api/maintenance-comments",l,{headers:{"Content-Type":"multipart/form-data"}})).data.success&&(u.value="",i.value=[],await M(),h("comment-added"),P(),p.fire({title:"Berhasil!",text:"Komentar berhasil ditambahkan.",icon:"success",timer:2e3,showConfirmButton:!1}))}catch(l){console.error("Error submitting comment:",l);let r="Terjadi kesalahan saat menyimpan komentar.";((a=l.response)==null?void 0:a.status)===422?r="Data komentar tidak valid. Silakan periksa input Anda.":((e=l.response)==null?void 0:e.status)===413?r="Ukuran file terlalu besar. Silakan gunakan file yang lebih kecil.":((s=l.response)==null?void 0:s.status)===500&&(r="Server error. Silakan coba lagi nanti."),p.fire({title:"Gagal Menyimpan Komentar",text:r,icon:"error",didOpen:()=>{const c=document.querySelector(".swal2-container");c&&(c.style.zIndex=2e5)}})}finally{v.value=!1}}}}function ae(a){w.value="/storage/"+a.file_path,_.value=a.file_type.startsWith("image/")?"image":"video",D.value=!0}function K(){D.value=!1,w.value="",_.value=""}function se(a){ae(a)}async function oe(a){if((await p.fire({title:"Yakin ingin menghapus komentar ini?",icon:"warning",showCancelButton:!0,confirmButtonText:"Ya, hapus!",cancelButtonText:"Batal",confirmButtonColor:"#e3342f",cancelButtonColor:"#6c757d",didOpen:()=>{const s=document.querySelector(".swal2-container");s&&(s.style.zIndex=2e5)}})).isConfirmed)try{await U.delete(`/api/maintenance-comments/${a}`),await M(),p.fire({title:"Terhapus!",text:"Komentar berhasil dihapus.",icon:"success",didOpen:()=>{const s=document.querySelector(".swal2-container");s&&(s.style.zIndex=2e5)}})}catch{p.fire({title:"Gagal",text:"Gagal menghapus komentar",icon:"error",didOpen:()=>{const l=document.querySelector(".swal2-container");l&&(l.style.zIndex=2e5)}})}}return(a,e)=>(o(),n(C,null,[(o(),E(z,{to:"body"},[b.value?(o(),E(me,{key:0,mode:S.value,onClose:Q,onCapture:X,class:"!z-[9999]"},null,8,["mode"])):f("",!0)])),(o(),E(z,{to:"body"},[D.value?(o(),n("div",ye,[t("div",{class:"fixed inset-0 bg-black/80",onClick:K}),t("div",he,[t("div",{class:"flex justify-between items-center mb-4"},[e[7]||(e[7]=t("h3",{class:"text-lg font-medium text-gray-900"},"Preview",-1)),t("button",{onClick:K,class:"text-gray-400 hover:text-red-500"},e[6]||(e[6]=[t("i",{class:"fas fa-times"},null,-1)]))]),_.value==="image"?(o(),n("div",ke,[t("img",{src:w.value,class:"max-h-[80vh] max-w-full object-contain"},null,8,be)])):_.value==="video"?(o(),n("div",we,[t("video",{src:w.value,controls:"",class:"max-h-[80vh] max-w-full"},null,8,_e)])):f("",!0)])])):f("",!0)])),y(g(xe),{appear:"",show:!0,as:"template"},{default:k(()=>[y(g(pe),{as:"div",onClose:e[5]||(e[5]=s=>h("close")),class:"relative z-[8888]"},{default:k(()=>[y(g(R),{enter:"duration-300 ease-out","enter-from":"opacity-0","enter-to":"opacity-100",leave:"duration-200 ease-in","leave-from":"opacity-100","leave-to":"opacity-0"},{default:k(()=>[y(g(ve),{class:"fixed inset-0 bg-black/40"})]),_:1}),t("div",Ce,[t("div",Ie,[y(g(R),{enter:"duration-300 ease-out","enter-from":"opacity-0 scale-95","enter-to":"opacity-100 scale-100",leave:"duration-200 ease-in","leave-from":"opacity-100 scale-100","leave-to":"opacity-0 scale-95"},{default:k(()=>[y(g(ge),{class:"w-[98%] max-w-[2000px] transform overflow-hidden rounded-2xl bg-white p-6 shadow-xl transition-all"},{default:k(()=>[t("div",Se,[e[9]||(e[9]=t("h3",{class:"text-lg font-medium text-gray-900"},"Komentar",-1)),t("button",{onClick:e[0]||(e[0]=s=>h("close")),class:"text-gray-400 hover:text-red-500"},e[8]||(e[8]=[t("i",{class:"fas fa-times"},null,-1)]))]),t("div",je,[j.value?(o(),n("div",De,e[10]||(e[10]=[t("i",{class:"fas fa-spinner fa-spin text-blue-500 text-2xl"},null,-1),t("p",{class:"text-gray-600 mt-2"},"Memuat komentar...",-1)]))):I.value.length===0?(o(),n("div",Me,e[11]||(e[11]=[t("i",{class:"far fa-comment text-gray-400 text-2xl"},null,-1),t("p",{class:"text-gray-500 mt-2"},"Belum ada komentar",-1)]))):(o(!0),n(C,{key:2},$(I.value,s=>{var l;return o(),n("div",{key:s.id,class:"bg-gray-50 rounded-lg p-4"},[t("div",Be,[t("div",Te,x(J(s.user_name)),1),t("div",Ee,[t("div",$e,[t("div",null,[t("span",Fe,x(s.user_name),1),t("span",Ue,x(H(s.created_at)),1)]),s.user_id===g(G).id?(o(),n("button",{key:0,onClick:r=>oe(s.id),class:"text-red-400 hover:text-red-600 ml-2",title:"Hapus komentar"},e[12]||(e[12]=[t("i",{class:"fas fa-trash"},null,-1)]),8,Le)):f("",!0)]),t("p",Ae,x(s.comment),1),(l=s.attachments)!=null&&l.length?(o(),n("div",Ne,[(o(!0),n(C,null,$(s.attachments,r=>(o(),n("div",{key:r.id,class:"relative group cursor-pointer",onClick:c=>se(r)},[r.file_type.startsWith("image/")?(o(),n("img",{key:0,src:"/storage/"+r.file_path,class:"w-32 h-32 object-cover rounded-lg border shadow-sm hover:shadow-md transition-all"},null,8,Oe)):r.file_type.startsWith("video/")?(o(),n("div",ze,[e[13]||(e[13]=t("i",{class:"fas fa-play text-gray-500 text-2xl group-hover:scale-110 transition-transform"},null,-1)),t("video",{src:"/storage/"+r.file_path,class:"hidden"},null,8,Re)])):(o(),n("div",We,[e[14]||(e[14]=t("i",{class:"fas fa-file text-gray-500 text-2xl"},null,-1)),t("span",qe,x(r.file_name),1)]))],8,Ke))),128))])):f("",!0)])])])}),128))]),t("div",Ge,[de(t("textarea",{"onUpdate:modelValue":e[1]||(e[1]=s=>u.value=s),onInput:V,rows:"4",class:"w-full border rounded-lg p-3 mb-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Tulis komentar... (Ctrl+Enter untuk kirim)"},null,544),[[ue,u.value]]),u.value.trim()||i.value.length>0?(o(),n("div",Ve,e[15]||(e[15]=[t("i",{class:"fas fa-save text-blue-500"},null,-1),t("span",null,"Draft tersimpan otomatis",-1)]))):f("",!0),e[21]||(e[21]=t("div",{class:"text-xs text-gray-400 mb-3"},[t("span",{class:"font-medium"},"Keyboard shortcuts:"),t("kbd",{class:"px-1 py-0.5 bg-gray-100 rounded text-xs"},"Ctrl+Enter"),F(" untuk kirim, "),t("kbd",{class:"px-1 py-0.5 bg-gray-100 rounded text-xs"},"Esc"),F(" untuk tutup ")],-1)),i.value.length?(o(),n("div",Ye,[(o(!0),n(C,null,$(i.value,(s,l)=>(o(),n("div",{key:l,class:"relative group"},[s.type.startsWith("image/")?(o(),n("img",{key:0,src:s.preview,class:"w-32 h-32 object-cover rounded-lg border shadow-sm"},null,8,Pe)):s.type.startsWith("video/")?(o(),n("video",{key:1,src:s.preview,class:"w-40 h-32 rounded-lg border shadow-sm"},null,8,Je)):(o(),n("div",He,[e[16]||(e[16]=t("i",{class:"fas fa-file text-gray-500 text-2xl"},null,-1)),t("span",Qe,x(s.file.name),1)])),t("button",{onClick:r=>ee(l),class:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600"},e[17]||(e[17]=[t("i",{class:"fas fa-times"},null,-1)]),8,Xe)]))),128))])):f("",!0),t("div",Ze,[t("div",et,[t("button",{onClick:e[2]||(e[2]=s=>A("photo")),class:"p-2 text-gray-600 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-all",title:"Ambil Foto"},e[18]||(e[18]=[t("i",{class:"fas fa-camera text-lg"},null,-1)])),t("button",{onClick:e[3]||(e[3]=s=>A("video")),class:"p-2 text-gray-600 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-all",title:"Rekam Video"},e[19]||(e[19]=[t("i",{class:"fas fa-video text-lg"},null,-1)])),t("button",{onClick:e[4]||(e[4]=s=>a.$refs.fileInput.click()),class:"p-2 text-gray-600 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-all",title:"Upload File"},e[20]||(e[20]=[t("i",{class:"fas fa-paperclip text-lg"},null,-1)])),t("input",{ref:"fileInput",type:"file",multiple:"",accept:"image/*,video/*,application/pdf,.doc,.docx,.xls,.xlsx",class:"hidden",onChange:Z},null,544)]),t("button",{onClick:N,disabled:!B.value||v.value,class:ce(["px-6 py-2 rounded-lg text-white text-base font-medium transition-all flex items-center gap-2",B.value&&!v.value?"bg-blue-500 hover:bg-blue-600":"bg-gray-300 cursor-not-allowed"])},[v.value?(o(),n("i",at)):f("",!0),F(" "+x(v.value?"Menyimpan...":"Kirim"),1)],10,tt)])])]),_:1})]),_:1})])])]),_:1})]),_:1})],64))}},ct=fe(st,[["__scopeId","data-v-e8ac8fe8"]]);export{ct as default};
