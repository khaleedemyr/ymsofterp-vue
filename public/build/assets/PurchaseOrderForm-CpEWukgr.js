import{r as m,w as M,c as L,A as U,B as o,C as v,x as b,Q as _,D as e,L as n,F as k,M as w,H as P,N as u,l as $,E as S,I as z,J as A,X as H}from"./vendor-vue-g7iCcTkf.js";import{a as R}from"./vendor-utils-CpgP2uT4.js";import{S as y}from"./app-C51E4rvH.js";import{Y as T,h as V,G as Y,S as J}from"./vendor-ui-CrPgGUUb.js";import"./vendor-charts-CuqD4wLC.js";const Q={class:"fixed inset-0 overflow-y-auto"},X={class:"flex min-h-full items-center justify-center p-4 text-center"},K={class:"space-y-4"},W={key:0,class:"flex items-center justify-center py-8"},Z={key:1,class:"text-center py-8 text-gray-500"},ee={key:2,class:"space-y-4"},se={class:"flex justify-between items-start"},te={class:"font-semibold"},ae={class:"text-sm text-gray-500"},re=["onClick"],ie={key:0,class:"space-y-4"},le={class:"grid grid-cols-2 gap-4 mb-3"},oe={class:"font-medium"},ne={key:0,class:"text-sm text-gray-600"},de={class:"text-right"},ue={class:"text-sm text-gray-600"},ce={class:"grid grid-cols-2 gap-4"},pe=["onUpdate:modelValue"],fe=["value"],me=["onUpdate:modelValue"],ve={class:"flex justify-end gap-2 mt-6"},_e=["disabled"],ye=["disabled"],he={key:0,class:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},Pe={__name:"PurchaseOrderForm",props:{show:Boolean,taskId:[String,Number]},emits:["close","po-created"],setup(D,{emit:I}){const x=D,E=I,h=m(!1),c=m(!1),f=m([]),p=m([]),C=m([]);M(()=>x.show,async t=>{t&&await Promise.all([F(),j()])});async function F(){h.value=!0;try{const t=await R.get(`/api/maintenance-tasks/${x.taskId}/purchase-requisitions`);f.value=t.data.filter(s=>s.status==="APPROVED")}catch(t){console.error("Error fetching PRs:",t),y.fire("Error","Gagal mengambil data PR","error")}finally{h.value=!1}}async function j(){try{const t=await R.get("/api/suppliers");C.value=t.data}catch(t){console.error("Error fetching suppliers:",t),y.fire("Error","Gagal mengambil data supplier","error")}}function q(t){const s=p.value.indexOf(t.id);s===-1?p.value.push(t.id):p.value.splice(s,1)}async function N(){var t,s;if(O.value){c.value=!0;try{const a=f.value.filter(l=>p.value.includes(l.id));if(a.length===0){y.fire("Error","Silakan pilih minimal satu PR","error");return}const d={};a.forEach(l=>{l.items.forEach(r=>{!r.selected_supplier_id||!r.supplier_price||(d[r.selected_supplier_id]||(d[r.selected_supplier_id]=[]),d[r.selected_supplier_id].push({item_name:r.item_name,description:r.description,specifications:r.specifications,quantity:r.quantity,unit_id:r.unit_id,price:r.price,supplier_price:r.supplier_price,subtotal:r.quantity*r.supplier_price,pr_id:l.id,pr_item_id:r.id}))})});const i=Object.entries(d).map(([l,r])=>R.post(`/api/maintenance-tasks/${x.taskId}/purchase-orders`,{supplier_id:l,items:r}));await Promise.all(i),E("po-created"),g(),y.fire("Sukses","PO berhasil dibuat","success")}catch(a){console.error("Error creating PO:",a),y.fire("Error",((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Gagal membuat PO","error")}finally{c.value=!1}}}const O=L(()=>{const t=f.value.filter(a=>p.value.includes(a.id));let s=!1;for(const a of t){for(const d of a.items)if(d.selected_supplier_id&&d.supplier_price){s=!0;break}if(s)break}return s});function g(){c.value||E("close")}function G(t){return new Date(t).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"})}function B(t){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(t)}return(t,s)=>(o(),U(_(J),{appear:"",show:D.show,as:"template"},{default:v(()=>[b(_(T),{as:"div",onClose:g,class:"relative z-[99999]"},{default:v(()=>[b(_(V),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0","enter-to":"opacity-100",leave:"duration-200 ease-in","leave-from":"opacity-100","leave-to":"opacity-0"},{default:v(()=>s[0]||(s[0]=[e("div",{class:"fixed inset-0 bg-black bg-opacity-25"},null,-1)])),_:1}),e("div",Q,[e("div",X,[b(_(V),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0 scale-95","enter-to":"opacity-100 scale-100",leave:"duration-200 ease-in","leave-from":"opacity-100 scale-100","leave-to":"opacity-0 scale-95"},{default:v(()=>[b(_(Y),{class:"w-full max-w-4xl transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all"},{default:v(()=>[e("div",{class:"flex justify-between items-center mb-4"},[s[2]||(s[2]=e("h3",{class:"text-lg font-medium"},"Buat Purchase Order",-1)),e("button",{onClick:g,class:"text-gray-400 hover:text-gray-600"},s[1]||(s[1]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",K,[h.value?(o(),n("div",W,s[3]||(s[3]=[e("div",{class:"flex items-center gap-2"},[e("div",{class:"w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}),e("span",null,"Loading PRs...")],-1)]))):!h.value&&f.value.length===0?(o(),n("div",Z," Tidak ada PR yang tersedia untuk dikonversi ke PO. ")):(o(),n("div",ee,[(o(!0),n(k,null,w(f.value,a=>{var d;return o(),n("div",{key:a.id,class:"border rounded-lg p-4"},[e("div",se,[e("div",null,[e("h4",te,u(a.pr_number),1),e("p",ae,u(G(a.created_at)),1)]),e("button",{onClick:i=>q(a),class:"text-blue-600 hover:text-blue-800"},[e("i",{class:$(["fas",p.value.includes(a.id)?"fa-chevron-up":"fa-chevron-down"])},null,2)],8,re)]),P(e("div",null,[(d=a.items)!=null&&d.length?(o(),n("div",ie,[(o(!0),n(k,null,w(a.items,i=>(o(),n("div",{key:i.id,class:"bg-gray-50 p-4 rounded"},[e("div",le,[e("div",null,[e("div",oe,u(i.item_name),1),i.specifications?(o(),n("div",ne,u(i.specifications),1)):S("",!0)]),e("div",de,[e("div",null,u(i.quantity)+" x "+u(B(i.price)),1),e("div",ue," Subtotal: "+u(B(i.quantity*i.price)),1)])]),e("div",ce,[e("div",null,[s[5]||(s[5]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Supplier ",-1)),P(e("select",{"onUpdate:modelValue":l=>i.selected_supplier_id=l,class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"},[s[4]||(s[4]=e("option",{value:""},"Pilih Supplier",-1)),(o(!0),n(k,null,w(C.value,l=>(o(),n("option",{key:l.id,value:l.id},u(l.name),9,fe))),128))],8,pe),[[z,i.selected_supplier_id]])]),e("div",null,[s[6]||(s[6]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Harga Supplier ",-1)),P(e("input",{type:"number","onUpdate:modelValue":l=>i.supplier_price=l,class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Masukkan harga dari supplier"},null,8,me),[[A,i.supplier_price]])])])]))),128))])):S("",!0)],512),[[H,p.value.includes(a.id)]])])}),128))]))]),e("div",ve,[e("button",{onClick:g,class:"px-4 py-2 text-gray-700 bg-gray-100 rounded hover:bg-gray-200",disabled:c.value}," Batal ",8,_e),e("button",{onClick:N,class:"px-4 py-2 text-white bg-blue-500 rounded hover:bg-blue-600 flex items-center gap-2",disabled:!O.value||c.value},[c.value?(o(),n("div",he)):S("",!0),e("span",null,u(c.value?"Menyimpan...":"Buat PO"),1)],8,ye)])]),_:1})]),_:1})])])]),_:1})]),_:1},8,["show"]))}};export{Pe as default};
