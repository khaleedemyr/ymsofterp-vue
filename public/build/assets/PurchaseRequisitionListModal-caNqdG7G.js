import{a as m}from"./vendor-utils-CpgP2uT4.js";import oe from"./PurchaseRequisitionForm-BTYU1WM6.js";import{S as f}from"./app-BujIObx9.js";import{r as h,w as ae,c as ne,$ as K,L as l,B as i,A as I,E as c,D as t,G as ie,F as w,M as S,T as Q,N as n,l as q}from"./vendor-vue-g7iCcTkf.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./vendor-charts-CuqD4wLC.js";const re={key:0,class:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/40"},ce={class:"bg-white rounded-xl shadow-lg w-full max-w-4xl p-6 relative flex flex-col",style:{"max-height":"80vh"}},de={class:"flex-1 overflow-y-auto",style:{"max-height":"50vh"}},ue={key:0,class:"text-center py-8"},pe={key:1,class:"text-center text-gray-400 py-8"},ve={key:2},_e={class:"flex justify-between items-start mb-2"},ge=["onClick"],xe={class:"text-xs text-gray-500"},fe={class:"text-xs text-gray-400"},me={class:"flex gap-2"},ye=["onClick"],he=["onClick"],be=["onClick"],ke=["onClick"],we=["onClick"],Ce={class:"text-sm mb-2"},Pe={key:0,class:"mt-2"},Re={class:"text-xs ml-4 list-disc"},Ee={class:"mt-3 border-t pt-2"},Ae={class:"grid grid-cols-1 gap-2"},$e={key:0,class:"text-xs"},Ne={key:0,class:"text-gray-400 ml-1"},je={key:1,class:"text-gray-600 ml-1"},De={key:2,class:"text-gray-500 ml-2 mt-0.5"},Be={key:1,class:"text-xs"},Le={key:0,class:"text-gray-400 ml-1"},Ie={key:1,class:"text-gray-600 ml-1"},Se={key:2,class:"text-gray-500 ml-2 mt-0.5"},qe={key:2,class:"text-xs"},Oe={key:0,class:"text-gray-400 ml-1"},Fe={key:1,class:"text-gray-600 ml-1"},Te={key:2,class:"text-gray-500 ml-2 mt-0.5"},Ue={key:0,class:"fixed inset-0 z-[99999] flex items-center justify-center bg-black/40"},Ve={class:"bg-white rounded-xl shadow-lg w-full max-w-lg p-6 relative"},Ge={key:0},Je={class:"mb-2 font-bold text-blue-700"},He={class:"mb-2 text-xs text-gray-500"},Me={class:"mb-2 text-xs text-gray-400"},ze={class:"mb-2"},Ye={key:0},Ke={class:"text-xs ml-4 list-disc"},Qe={class:"mt-4"},We={class:"mb-4"},Xe={class:"flex items-center space-x-4"},Ze={class:"flex-1"},et={key:0,class:"text-green-600"},tt={class:"text-sm text-gray-600"},st={class:"text-sm text-gray-600"},ot={key:0,class:"text-sm text-gray-600 mt-1"},at={key:1,class:"text-red-600"},nt={class:"text-sm text-gray-600"},it={class:"text-sm text-gray-600"},lt={key:0,class:"text-sm text-gray-600 mt-1"},rt={key:2,class:"text-yellow-600"},ct={class:"flex items-center"},dt={class:"mb-4"},ut={class:"flex items-center space-x-4"},pt={class:"flex-1"},vt={key:0,class:"text-green-600"},_t={class:"text-sm text-gray-600"},gt={class:"text-sm text-gray-600"},xt={key:0,class:"text-sm text-gray-600 mt-1"},ft={key:1,class:"text-red-600"},mt={class:"text-sm text-gray-600"},yt={class:"text-sm text-gray-600"},ht={key:0,class:"text-sm text-gray-600 mt-1"},bt={key:2,class:"text-yellow-600"},kt={class:"flex items-center"},wt={key:0,class:"mb-4"},Ct={class:"flex items-center space-x-4"},Pt={class:"flex-1"},Rt={key:0,class:"text-green-600"},Et={class:"text-sm text-gray-600"},At={class:"text-sm text-gray-600"},$t={key:0,class:"text-sm text-gray-600 mt-1"},Nt={key:1,class:"text-red-600"},jt={class:"text-sm text-gray-600"},Dt={class:"text-sm text-gray-600"},Bt={key:0,class:"text-sm text-gray-600 mt-1"},Lt={key:2,class:"text-yellow-600"},It={class:"flex items-center"},St={class:"mt-4 flex flex-wrap gap-2"},qt={key:0,class:"flex gap-2"},Ot={key:1,class:"flex gap-2"},Ft={key:2,class:"flex gap-2"},Tt={__name:"PurchaseRequisitionListModal",props:{show:Boolean,taskId:[String,Number]},setup(C){const P=C,y=h([]),R=h(!1),b=h(!1),E=h(null),A=h(!1),a=h(null);function v(o){return new Date(o).toLocaleString("id-ID",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}const $=o=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(o);async function N(){if(P.taskId){R.value=!0;try{const o=await m.get(`/api/maintenance-tasks/${P.taskId}/purchase-requisitions`);console.log("Fetched PRs:",o.data),y.value=o.data}catch(o){console.error("Error fetching PRs:",o),y.value=[]}finally{R.value=!1}}}async function W(o){(await f.fire({title:"Hapus PR?",text:`Yakin ingin menghapus PR ${o.pr_number}?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Ya, hapus",cancelButtonText:"Batal"})).isConfirmed&&(await m.delete(`/api/maintenance-purchase-requisitions/${o.id}`),N(),f.fire("Berhasil","PR berhasil dihapus","success"))}function X(o){E.value=o,b.value=!0}async function O(o){console.log("Opening PR detail:",o),a.value=o,A.value=!0}function Z(){b.value=!1,E.value=null,N()}function ee(o,e){const r=K().props.auth.user;console.log("Raw user data:",r);const u=r==null?void 0:r.id_role,d=r==null?void 0:r.id_jabatan,p=r==null?void 0:r.status;if(console.log("Extracted values:",{userRole:u,userJabatan:d,userStatus:p}),p!=="A")return console.log("User not active"),!1;const g=u==="5af56935b011a",x=d===217;if(console.log("Role checks:",{isSuperAdmin:g,isSecretary:x,userRole:u,expectedRole:"5af56935b011a",roleMatch:u==="5af56935b011a"}),g||x)return console.log("User is superadmin or secretary"),!0;let s=!1;switch(o){case"chief_engineering":s=d===165||d===262;break;case"coo":s=d===151;break;case"ceo":!(e!=null&&e.total_amount)||e.total_amount<5e6?s=!1:s=d===149;break;default:s=!1}return console.log(`Approval check for ${o}:`,s),s}function j(o,e){if(console.log(`Checking button visibility for ${o}`,{pr_data:{chief_eng:e.chief_engineering_approval,coo:e.coo_approval,ceo:e.ceo_approval}}),!e||!ee(o,e))return console.log(`${o}: No PR data or cannot approve`),!1;const r=p=>(p==null?void 0:p.toLowerCase())==="approved",u=p=>!p||p.toLowerCase()==="pending";let d=!1;switch(o){case"chief_engineering":d=u(e.chief_engineering_approval);break;case"coo":d=r(e.chief_engineering_approval)&&u(e.coo_approval);break;case"ceo":d=e.total_amount>=5e6&&r(e.coo_approval)&&u(e.ceo_approval);break;default:d=!1}return console.log(`Button visibility for ${o}:`,d),d}async function D(o,e){try{await m.post(`/api/maintenance-purchase-requisitions/${o}/update-status`,{status:e})}catch(r){console.error("Failed to update PR status:",r)}}async function F(o){var d,p,g,x,s,k;if(((d=o.chief_engineering_approval)==null?void 0:d.toLowerCase())==="rejected"||((p=o.coo_approval)==null?void 0:p.toLowerCase())==="rejected"||o.total_amount>=5e6&&((g=o.ceo_approval)==null?void 0:g.toLowerCase())==="rejected"){await D(o.id,"REJECTED");return}const e=((x=o.chief_engineering_approval)==null?void 0:x.toLowerCase())==="approved",r=((s=o.coo_approval)==null?void 0:s.toLowerCase())==="approved",u=((k=o.ceo_approval)==null?void 0:k.toLowerCase())==="approved";o.total_amount<5e6?e&&r&&await D(o.id,"APPROVED"):e&&r&&u&&await D(o.id,"APPROVED")}async function B(o,e){var u,d;const{value:r}=await f.fire({title:"Approve PR",input:"textarea",inputLabel:"Approval Notes",inputPlaceholder:"Enter approval notes (optional)...",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel"});if(r!==void 0)try{await m.post(`/api/maintenance-purchase-requisitions/${a.value.id}/approve`,{approval_type:o,status:e,notes:r}),o==="coo"&&e==="approved"&&a.value.total_amount<5e6&&await m.post(`/api/maintenance-purchase-requisitions/${a.value.id}/approve`,{approval_type:"ceo",status:"approved",notes:"Auto approved - PR under 5 million"}),await T(),await F(a.value),f.fire("Success","PR approved successfully","success")}catch(p){f.fire("Error",((d=(u=p.response)==null?void 0:u.data)==null?void 0:d.error)||"Failed to approve PR","error")}}async function L(o){var r,u;const{value:e}=await f.fire({title:"Reject PR",input:"textarea",inputLabel:"Rejection Notes",inputPlaceholder:"Enter rejection notes (required)...",inputValidator:d=>{if(!d)return"Notes are required for rejection!"},showCancelButton:!0,confirmButtonText:"Reject",cancelButtonText:"Cancel"});if(e)try{await m.post(`/api/maintenance-purchase-requisitions/${a.value.id}/approve`,{approval_type:o,status:"rejected",notes:e}),await T(),await F(a.value),f.fire("Success","PR rejected successfully","success")}catch(d){f.fire("Error",((u=(r=d.response)==null?void 0:r.data)==null?void 0:u.error)||"Failed to reject PR","error")}}async function T(){try{const o=await m.get(`/api/maintenance-tasks/${a.value.task_id}/purchase-requisitions`);console.log("Refreshing PR details, response:",o.data);const e=o.data.find(r=>r.id===a.value.id);if(console.log("Updated PR:",e),e){a.value=e;const r=y.value.findIndex(u=>u.id===e.id);r!==-1&&(y.value[r]=e)}}catch(o){console.error("Failed to refresh PR details:",o)}}ae(()=>P.show,o=>{o&&N()}),ne(()=>{const o=K().props.auth.user;return(o.id_role==="5af56935b011a"||o.id_jabatan===217)&&o.status==="A"});const te=o=>{window.open(`/maintenance-ba/${o.id}/preview`,"_blank")},se=o=>{window.open(`/maintenance-pr/${o.id}/preview`,"_blank")};return(o,e)=>{var r,u,d,p,g,x;return i(),l(w,null,[(i(),I(Q,{to:"body"},[C.show?(i(),l("div",re,[t("div",ce,[t("button",{onClick:e[0]||(e[0]=s=>o.$emit("close")),class:"absolute top-3 right-3 text-gray-400 hover:text-gray-600"},e[9]||(e[9]=[t("i",{class:"fas fa-times text-lg"},null,-1)])),e[16]||(e[16]=t("h2",{class:"text-xl font-bold mb-4 text-center"},"Purchase Requisition (PR)",-1)),t("button",{onClick:e[1]||(e[1]=s=>b.value=!b.value),class:"mb-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 w-max self-end"},e[10]||(e[10]=[t("i",{class:"fas fa-plus"},null,-1),ie(" Buat PR Baru ")])),b.value?(i(),I(oe,{key:0,"task-id":C.taskId,"on-saved":Z,"edit-pr":E.value},null,8,["task-id","edit-pr"])):c("",!0),t("div",de,[R.value?(i(),l("div",ue,"Loading...")):y.value.length===0?(i(),l("div",pe,"Belum ada PR.")):(i(),l("div",ve,[(i(!0),l(w,null,S(y.value,s=>{var k,U,V,G,J,H,M,z,Y;return i(),l("div",{key:s.id,class:"border rounded p-4 mb-4 bg-gray-50"},[t("div",_e,[t("div",null,[t("div",{class:"font-bold text-blue-700 cursor-pointer hover:underline",onClick:_=>O(s)},n(s.pr_number),9,ge),t("div",xe,"Status: "+n(s.status)+" | Total: "+n($(s.total_amount)),1),t("div",fe,n(v(s.created_at)),1)]),t("div",me,[t("button",{onClick:_=>O(s),class:"text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded"}," Detail ",8,ye),t("button",{onClick:_=>te(s),class:"text-xs px-2 py-1 bg-yellow-100 hover:bg-yellow-200 rounded"}," Preview BA ",8,he),t("button",{onClick:_=>se(s),class:"text-xs px-2 py-1 bg-yellow-100 hover:bg-yellow-200 rounded"}," Preview PR ",8,be),t("button",{onClick:_=>X(s),class:"px-2 py-1 text-xs bg-yellow-200 rounded hover:bg-yellow-300"},"Edit",8,ke),t("button",{onClick:_=>W(s),class:"px-2 py-1 text-xs bg-red-200 text-red-700 rounded hover:bg-red-300"},"Hapus",8,we)])]),t("div",Ce,n(s.description),1),s.items&&s.items.length?(i(),l("div",Pe,[e[11]||(e[11]=t("div",{class:"font-semibold text-xs mb-1"},"Items:",-1)),t("ul",Re,[(i(!0),l(w,null,S(s.items,_=>(i(),l("li",{key:_.id},n(_.item_name)+" ("+n(_.quantity)+" x "+n($(_.price))+") = "+n($(_.subtotal)),1))),128))])])):c("",!0),t("div",Ee,[e[15]||(e[15]=t("div",{class:"text-xs font-semibold mb-2"},"Approval Status:",-1)),t("div",Ae,[s.chief_engineering_approval?(i(),l("div",$e,[e[12]||(e[12]=t("span",{class:"font-medium"},"CHIEF ENGINEERING:",-1)),t("span",{class:q({"text-green-600":((k=s.chief_engineering_approval)==null?void 0:k.toUpperCase())==="APPROVED","text-red-600":((U=s.chief_engineering_approval)==null?void 0:U.toUpperCase())==="REJECTED","text-gray-600":((V=s.chief_engineering_approval)==null?void 0:V.toUpperCase())==="PENDING"})},n(s.chief_engineering_approval),3),s.chief_engineering_approval_date?(i(),l("span",Ne," ("+n(v(s.chief_engineering_approval_date))+") ",1)):c("",!0),s.chief_engineering_approval_by_user?(i(),l("span",je," - by "+n(s.chief_engineering_approval_by_user.nama_lengkap),1)):c("",!0),s.chief_engineering_approval_notes?(i(),l("div",De,n(s.chief_engineering_approval_notes),1)):c("",!0)])):c("",!0),s.coo_approval?(i(),l("div",Be,[e[13]||(e[13]=t("span",{class:"font-medium"},"COO:",-1)),t("span",{class:q({"text-green-600":((G=s.coo_approval)==null?void 0:G.toUpperCase())==="APPROVED","text-red-600":((J=s.coo_approval)==null?void 0:J.toUpperCase())==="REJECTED","text-gray-600":((H=s.coo_approval)==null?void 0:H.toUpperCase())==="PENDING"})},n(s.coo_approval),3),s.coo_approval_date?(i(),l("span",Le," ("+n(v(s.coo_approval_date))+") ",1)):c("",!0),s.coo_approval_by_user?(i(),l("span",Ie," - by "+n(s.coo_approval_by_user.nama_lengkap),1)):c("",!0),s.coo_approval_notes?(i(),l("div",Se,n(s.coo_approval_notes),1)):c("",!0)])):c("",!0),s.ceo_approval&&s.total_amount>=5e6?(i(),l("div",qe,[e[14]||(e[14]=t("span",{class:"font-medium"},"CEO:",-1)),t("span",{class:q({"text-green-600":((M=s.ceo_approval)==null?void 0:M.toUpperCase())==="APPROVED","text-red-600":((z=s.ceo_approval)==null?void 0:z.toUpperCase())==="REJECTED","text-gray-600":((Y=s.ceo_approval)==null?void 0:Y.toUpperCase())==="PENDING"})},n(s.ceo_approval),3),s.ceo_approval_date?(i(),l("span",Oe," ("+n(v(s.ceo_approval_date))+") ",1)):c("",!0),s.ceo_approval_by_user?(i(),l("span",Fe," - by "+n(s.ceo_approval_by_user.nama_lengkap),1)):c("",!0),s.ceo_approval_notes?(i(),l("div",Te,n(s.ceo_approval_notes),1)):c("",!0)])):c("",!0)])])])}),128))]))])])])):c("",!0)])),(i(),I(Q,{to:"body"},[A.value?(i(),l("div",Ue,[t("div",Ve,[t("button",{onClick:e[2]||(e[2]=s=>A.value=!1),class:"absolute top-3 right-3 text-gray-400 hover:text-gray-600"},e[17]||(e[17]=[t("i",{class:"fas fa-times text-lg"},null,-1)])),e[31]||(e[31]=t("h2",{class:"text-xl font-bold mb-4 text-center"},"Detail PR",-1)),a.value?(i(),l("div",Ge,[t("div",Je,n(a.value.pr_number),1),t("div",He,"Status: "+n(a.value.status)+" | Total: "+n(a.value.total_amount),1),t("div",Me,n(v(a.value.created_at)),1),t("div",ze,n(a.value.description),1),a.value.items&&a.value.items.length?(i(),l("div",Ye,[e[18]||(e[18]=t("div",{class:"font-semibold text-xs mb-1"},"Items:",-1)),t("ul",Ke,[(i(!0),l(w,null,S(a.value.items,s=>(i(),l("li",{key:s.id},n(s.item_name)+" ("+n(s.quantity)+" x "+n(s.price)+") = "+n(s.subtotal),1))),128))])])):c("",!0),t("div",Qe,[t("div",We,[e[22]||(e[22]=t("h3",{class:"text-lg font-semibold mb-2"},"Chief Engineering Approval",-1)),t("div",Xe,[t("div",Ze,[((r=a.value.chief_engineering_approval)==null?void 0:r.toLowerCase())==="approved"?(i(),l("div",et,[e[19]||(e[19]=t("div",{class:"flex items-center"},[t("i",{class:"fas fa-check-circle mr-2"}),t("span",null,"Approved")],-1)),t("div",tt,n(v(a.value.chief_engineering_approval_date)),1),t("div",st,n(a.value.chief_engineering_approval_by_name),1),a.value.chief_engineering_approval_notes?(i(),l("div",ot," Notes: "+n(a.value.chief_engineering_approval_notes),1)):c("",!0)])):((u=a.value.chief_engineering_approval)==null?void 0:u.toLowerCase())==="rejected"?(i(),l("div",at,[e[20]||(e[20]=t("div",{class:"flex items-center"},[t("i",{class:"fas fa-times-circle mr-2"}),t("span",null,"Rejected")],-1)),t("div",nt,n(v(a.value.chief_engineering_approval_date)),1),t("div",it,n(a.value.chief_engineering_approval_by_name),1),a.value.chief_engineering_approval_notes?(i(),l("div",lt," Notes: "+n(a.value.chief_engineering_approval_notes),1)):c("",!0)])):(i(),l("div",rt,[t("div",ct,[e[21]||(e[21]=t("i",{class:"fas fa-clock mr-2"},null,-1)),t("span",null,n(a.value.chief_engineering_approval||"Pending"),1)])]))])])]),t("div",dt,[e[26]||(e[26]=t("h3",{class:"text-lg font-semibold mb-2"},"COO Approval",-1)),t("div",ut,[t("div",pt,[((d=a.value.coo_approval)==null?void 0:d.toLowerCase())==="approved"?(i(),l("div",vt,[e[23]||(e[23]=t("div",{class:"flex items-center"},[t("i",{class:"fas fa-check-circle mr-2"}),t("span",null,"Approved")],-1)),t("div",_t,n(v(a.value.coo_approval_date)),1),t("div",gt,n(a.value.coo_approval_by_name),1),a.value.coo_approval_notes?(i(),l("div",xt," Notes: "+n(a.value.coo_approval_notes),1)):c("",!0)])):((p=a.value.coo_approval)==null?void 0:p.toLowerCase())==="rejected"?(i(),l("div",ft,[e[24]||(e[24]=t("div",{class:"flex items-center"},[t("i",{class:"fas fa-times-circle mr-2"}),t("span",null,"Rejected")],-1)),t("div",mt,n(v(a.value.coo_approval_date)),1),t("div",yt,n(a.value.coo_approval_by_name),1),a.value.coo_approval_notes?(i(),l("div",ht," Notes: "+n(a.value.coo_approval_notes),1)):c("",!0)])):(i(),l("div",bt,[t("div",kt,[e[25]||(e[25]=t("i",{class:"fas fa-clock mr-2"},null,-1)),t("span",null,n(a.value.coo_approval||"Pending"),1)])]))])])]),a.value.total_amount>=5e6?(i(),l("div",wt,[e[30]||(e[30]=t("h3",{class:"text-lg font-semibold mb-2"},"CEO Approval",-1)),t("div",Ct,[t("div",Pt,[((g=a.value.ceo_approval)==null?void 0:g.toLowerCase())==="approved"?(i(),l("div",Rt,[e[27]||(e[27]=t("div",{class:"flex items-center"},[t("i",{class:"fas fa-check-circle mr-2"}),t("span",null,"Approved")],-1)),t("div",Et,n(v(a.value.ceo_approval_date)),1),t("div",At,n(a.value.ceo_approval_by_name),1),a.value.ceo_approval_notes?(i(),l("div",$t," Notes: "+n(a.value.ceo_approval_notes),1)):c("",!0)])):((x=a.value.ceo_approval)==null?void 0:x.toLowerCase())==="rejected"?(i(),l("div",Nt,[e[28]||(e[28]=t("div",{class:"flex items-center"},[t("i",{class:"fas fa-times-circle mr-2"}),t("span",null,"Rejected")],-1)),t("div",jt,n(v(a.value.ceo_approval_date)),1),t("div",Dt,n(a.value.ceo_approval_by_name),1),a.value.ceo_approval_notes?(i(),l("div",Bt," Notes: "+n(a.value.ceo_approval_notes),1)):c("",!0)])):(i(),l("div",Lt,[t("div",It,[e[29]||(e[29]=t("i",{class:"fas fa-clock mr-2"},null,-1)),t("span",null,n(a.value.ceo_approval||"Pending"),1)])]))])])])):c("",!0)]),t("div",St,[j("chief_engineering",a.value)?(i(),l("div",qt,[t("button",{onClick:e[3]||(e[3]=s=>B("chief_engineering","approved")),class:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-xs"}," Approve CHIEF ENGINEERING "),t("button",{onClick:e[4]||(e[4]=s=>L("chief_engineering")),class:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs"}," Reject ")])):c("",!0),j("coo",a.value)?(i(),l("div",Ot,[t("button",{onClick:e[5]||(e[5]=s=>B("coo","approved")),class:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-xs"}," Approve COO "),t("button",{onClick:e[6]||(e[6]=s=>L("coo")),class:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs"}," Reject ")])):c("",!0),j("ceo",a.value)?(i(),l("div",Ft,[t("button",{onClick:e[7]||(e[7]=s=>B("ceo","approved")),class:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-xs"}," Approve CEO "),t("button",{onClick:e[8]||(e[8]=s=>L("ceo")),class:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs"}," Reject ")])):c("",!0)])])):c("",!0)])])):c("",!0)]))],64)}}},zt=le(Tt,[["__scopeId","data-v-e671f944"]]);export{zt as default};
