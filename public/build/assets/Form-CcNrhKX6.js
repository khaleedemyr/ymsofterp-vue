import{c as tt,P as ht,r as E,w as M,a as et,j as pt,A as st,B as r,C as yt,D as n,L as u,E as f,G as C,N as m,O as ot,H as h,Q as i,J as b,F as w,M as k,I as N,l as nt,Z as T,T as bt,Y as wt,W as q,n as kt}from"./vendor-vue-g7iCcTkf.js";import{A as xt}from"./AppLayout-U5X72hCR.js";import{S as p}from"./app-CMkuePvF.js";import{a as A}from"./vendor-utils-CpgP2uT4.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ProfileUpdateModal-DCdSPjRr.js";import"./InputLabel-Bg0AMQZ3.js";import"./PrimaryButton-BbBAD9SX.js";import"./TextInput-B7P_xVe4.js";import"./vendor-charts-CuqD4wLC.js";const vt={class:"max-w-5xl w-full mx-auto py-8 px-2"},Dt={class:"flex items-center gap-2 mb-6"},It={class:"text-2xl font-bold text-gray-800 flex items-center gap-2 ml-4"},qt={key:0,class:"ml-auto"},St={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},$t={key:0,class:"text-xs text-red-500 mt-1"},Bt=["disabled"],Ct=["value"],Nt={key:0,class:"text-xs text-red-500 mt-1"},Tt=["disabled"],Ut=["value"],Vt={key:0,class:"text-xs text-red-500 mt-1"},Et=["disabled"],Mt=["value"],At={key:0,class:"text-xs text-red-500 mt-1"},jt={key:0,class:"text-xs text-red-500 mt-1"},Ft={key:0,class:"text-red-600 text-sm mb-2"},Kt={class:"w-full min-w-full divide-y divide-gray-200"},Ot={class:"px-3 py-2 min-w-[260px]"},Lt={class:"relative"},Pt=["id","onUpdate:modelValue","onInput","onFocus","onBlur","onKeydown"],Gt=["id"],Qt=["id","onMousedown"],zt={class:"font-medium"},Ht={class:"text-xs text-gray-500"},Wt={class:"text-sm text-gray-600"},Yt={key:0,class:"absolute right-2 top-2"},Jt={key:1,class:"text-xs text-yellow-600 mt-1"},Rt={key:2,class:"text-xs text-gray-500 mt-1"},Zt={key:0,class:"text-xs text-red-500 mt-1"},Xt={class:"px-3 py-2 min-w-[100px]"},te=["onUpdate:modelValue"],ee={key:0,class:"text-xs text-red-500 mt-1"},se={class:"px-3 py-2 min-w-[100px]"},oe=["onUpdate:modelValue","onChange"],ne=["value"],le=["onUpdate:modelValue"],ae={key:2,class:"text-xs text-red-500 mt-1"},ie={class:"px-3 py-2 min-w-[120px]"},re=["onUpdate:modelValue"],ue={class:"px-3 py-2"},de=["onClick","disabled"],me={class:"flex justify-end space-x-4"},ce=["disabled"],ve={__name:"Form",props:{outlets:Array,warehouseOutlets:Array,user_outlet_id:Number,editData:Object},setup(lt){var G,Q,z,H,W,Y,J;const c=lt,x=tt(()=>!!c.editData),s=ht({transfer_date:((G=c.editData)==null?void 0:G.transfer_date)||"",outlet_id:((Q=c.editData)==null?void 0:Q.outlet_id)||"",warehouse_outlet_from_id:((z=c.editData)==null?void 0:z.warehouse_outlet_from_id)||"",warehouse_outlet_to_id:((H=c.editData)==null?void 0:H.warehouse_outlet_to_id)||"",notes:((W=c.editData)==null?void 0:W.notes)||"",items:(J=(Y=c.editData)==null?void 0:Y.items)!=null&&J.length?JSON.parse(JSON.stringify(c.editData.items)):[{item_id:"",item_name:"",qty:"",unit:"",note:"",suggestions:[],showDropdown:!1,loading:!1,highlightedIndex:-1,available_units:[],selected_unit:"",_rowKey:Date.now()+"-"+Math.random()}]}),S=E([]),$=E([]);M(()=>s.outlet_id,async o=>{if(o)try{const t=await A.get("/api/warehouse-outlets/by-outlet",{params:{outlet_id:o}});S.value=t.data,$.value=t.data}catch(t){console.error("Error fetching warehouse outlets:",t),S.value=[],$.value=[]}else S.value=[],$.value=[];s.warehouse_outlet_from_id="",s.warehouse_outlet_to_id=""}),et(()=>{c.user_outlet_id&&c.user_outlet_id!==1&&(s.outlet_id=c.user_outlet_id)});const v=E([]);M(()=>s.items.length,o=>{Array.isArray(v.value)||(v.value=[]),v.value.length=o});function at(){s.items.push({item_id:"",item_name:"",qty:"",unit:"",note:"",suggestions:[],showDropdown:!1,loading:!1,highlightedIndex:-1,available_units:[],selected_unit:"",_rowKey:Date.now()+"-"+Math.random()}),kt(()=>{setTimeout(()=>{const o=s.items.length-1;v.value[o]&&v.value[o].focus()},0)})}function it(o){s.items.length!==1&&s.items.splice(o,1)}async function rt(o,t){if(console.log("fetchItemSuggestions called",{idx:o,q:t,warehouse_outlet:s.warehouse_outlet_from_id}),!t||t.length<2||!s.warehouse_outlet_from_id){s.items[o].suggestions=[],s.items[o].highlightedIndex=-1;return}s.items[o].loading=!0;try{const e=await A.get("/items/search-for-internal-warehouse-transfer",{params:{q:t,warehouse_outlet_id:s.warehouse_outlet_from_id}});console.log("API response:",e.data);let a=Array.isArray(e.data)?e.data:[];s.items[o].suggestions=a.map(l=>({...l,available_units:[l.unit_small,l.unit_medium,l.unit_large].filter(Boolean),unit_small:l.unit_small,unit_medium:l.unit_medium,unit_large:l.unit_large,small_unit_id:l.small_unit_id,medium_unit_id:l.medium_unit_id,large_unit_id:l.large_unit_id})),s.items[o].showDropdown=!0,s.items[o].highlightedIndex=0,console.log("Suggestions:",s.items[o].suggestions)}catch(e){console.error("Error fetching suggestions:",e),s.items[o].suggestions=[],s.items[o].highlightedIndex=-1}finally{s.items[o].loading=!1}}async function j(o){const t=s.items[o];if(!(!t.item_id||!s.warehouse_outlet_from_id))try{const e=await A.get("/api/outlet-inventory/stock",{params:{item_id:t.item_id,warehouse_outlet_id:s.warehouse_outlet_from_id}});if(t.stock=e.data,console.log("Fetched stock data:",t.stock),t.stock&&t.stock.qty_small!=null&&t.stock.medium_conversion_qty&&t.stock.small_conversion_qty){const a=Number(t.stock.qty_small||0),l=Number(t.stock.small_conversion_qty||1),_=Number(t.stock.medium_conversion_qty||1),D=Math.floor(a/(l*_)),I=a%(l*_),R=Math.floor(I/l),d=I%l;t.stock_display={qty_large:D,qty_medium:R,qty_small:d}}else t.stock_display=null}catch(e){console.error("Error fetching stock:",e),t.stock={qty_small:0,qty_medium:0,qty_large:0,unit_small:"",unit_medium:"",unit_large:"",small_conversion_qty:1,medium_conversion_qty:1},t.stock_display=null}}function U(o){return o==null?0:Number(o)%1===0?Number(o):Number(o).toLocaleString("id-ID",{minimumFractionDigits:0,maximumFractionDigits:2})}function ut(o){if(!o.stock)return"Stok: 0";const t=Number(o.stock.qty_small||0),e=Number(o.stock.qty_medium||0),a=Number(o.stock.qty_large||0);let l="Stok: ";const _=[];return(t>0||o.stock.unit_small)&&_.push(`${U(t)} ${o.stock.unit_small||""}`),(e>0||o.stock.unit_medium)&&_.push(`${U(e)} ${o.stock.unit_medium||""}`),(a>0||o.stock.unit_large)&&_.push(`${U(a)} ${o.stock.unit_large||""}`),_.length===0?"Stok: 0":l+_.join(" | ")}M(()=>s.warehouse_outlet_from_id,o=>{s.items.forEach((t,e)=>{t.item_id&&o&&j(e)})});function F(o,t){s.items[o].item_id=t.id,s.items[o].item_name=t.name,s.items[o].unit=t.unit_small||t.unit||"",s.items[o].selected_unit=t.unit_small||t.unit||"",s.items[o].available_units=[t.unit_small,t.unit_medium,t.unit_large].filter(Boolean),s.items[o].showDropdown=!1,s.items[o].suggestions=[],s.items[o].highlightedIndex=-1,j(o)}function K(o,t){const e=t.target.value;s.items[o].item_id="",s.items[o].item_name=e,s.items[o].showDropdown=!0,rt(o,e)}function dt(o){setTimeout(()=>{s.items[o].showDropdown=!1},200)}function B(o,t){const e=s.items[o];!e.showDropdown||!e.suggestions.length||(t.key==="ArrowDown"?(t.preventDefault(),e.highlightedIndex=(e.highlightedIndex+1)%e.suggestions.length):t.key==="ArrowUp"?(t.preventDefault(),e.highlightedIndex=(e.highlightedIndex-1+e.suggestions.length)%e.suggestions.length):t.key==="Enter"?(t.preventDefault(),e.highlightedIndex>=0&&e.suggestions[e.highlightedIndex]&&F(o,e.suggestions[e.highlightedIndex])):t.key==="Escape"&&(e.showDropdown=!1))}function mt(o,t){s.items[o].selected_unit=t.target.value,s.items[o].unit=t.target.value}function ct(o){const e=document.querySelectorAll('input[placeholder="Cari nama item..."]')[o];if(!e)return{};const a=e.getBoundingClientRect();return{left:a.left+"px",top:a.bottom+"px",width:a.width+"px",position:"fixed",zIndex:9999}}function O(o){if(o.key==="F1"){o.preventDefault();const e=`item-input-${s.items.length-1}`,a=document.getElementById(e);a&&(a.focus(),a.select(),a.style.outline="2px solid #2563eb",a.style.boxShadow="0 0 0 2px rgba(37, 99, 235, 0.2)",setTimeout(()=>{a.style.outline="",a.style.boxShadow=""},1e3))}}const L=tt(()=>s.outlet_id&&s.warehouse_outlet_from_id&&s.warehouse_outlet_to_id&&s.warehouse_outlet_from_id!==s.warehouse_outlet_to_id);function _t(){var o,t,e,a,l,_,D,I;for(const[R,d]of s.items.entries()){console.log("DEBUG VALIDASI QTY",{item:d,stock:d.stock,qty:d.qty,unit:d.selected_unit||d.unit});const Z=Number(d.qty||0);let g=0;const y=d.selected_unit||d.unit;if(y===((o=d.stock)==null?void 0:o.unit_small))g=Number(((t=d.stock)==null?void 0:t.qty_small)||0);else if(y===((e=d.stock)==null?void 0:e.unit_medium))g=Number(((a=d.stock)==null?void 0:a.qty_medium)||0);else if(y===((l=d.stock)==null?void 0:l.unit_large))g=Number(((_=d.stock)==null?void 0:_.qty_large)||0);else if((D=d.stock)!=null&&D.qty_small&&((I=d.stock)!=null&&I.unit_small)){const V=Number(d.stock.qty_small||0),X=Number(d.stock.small_conversion_qty||1),gt=Number(d.stock.medium_conversion_qty||1);y===d.stock.unit_medium?g=Math.floor(V/X):y===d.stock.unit_large?g=Math.floor(V/(X*gt)):g=V}else g=0;if(console.log("Stock validation:",{unit:y,stock:g,qty:Z,item_stock:d.stock}),Z>g){p.fire({icon:"error",title:"Gagal!",text:`Qty item "${d.item_name}" melebihi stok di departemen asal untuk unit ${y} (${g})`});return}}p.fire({title:x.value?"Menyimpan Perubahan...":"Menyimpan Data...",text:"Mohon tunggu sebentar",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{p.showLoading()}}),x.value?s.put(`/internal-warehouse-transfer/${c.editData.id}`,{onSuccess:()=>{p.fire({icon:"success",title:"Berhasil!",text:"Data berhasil diupdate",timer:1500,showConfirmButton:!1}).then(()=>{q.visit("/internal-warehouse-transfer")})},onError:()=>{p.fire({icon:"error",title:"Gagal!",text:"Terjadi kesalahan saat update data"})}}):s.post("/internal-warehouse-transfer",{onSuccess:()=>{p.fire({icon:"success",title:"Berhasil!",text:"Data berhasil disimpan",timer:1500,showConfirmButton:!1}).then(()=>{q.visit("/internal-warehouse-transfer")})},onError:()=>{p.fire({icon:"error",title:"Gagal!",text:"Terjadi kesalahan saat menyimpan data"})}})}function ft(){p.fire({title:"Hapus Data?",text:"Data transfer dan mutasi stok akan dihapus. Lanjutkan?",icon:"warning",showCancelButton:!0,confirmButtonText:"Ya, Hapus",cancelButtonText:"Batal"}).then(o=>{o.isConfirmed&&q.delete(`/internal-warehouse-transfer/${c.editData.id}`,{onSuccess:()=>{p.fire({icon:"success",title:"Berhasil!",text:"Data berhasil dihapus",timer:1500,showConfirmButton:!1}).then(()=>{q.visit("/internal-warehouse-transfer")})},onError:()=>{p.fire({icon:"error",title:"Gagal!",text:"Terjadi kesalahan saat menghapus data"})}})})}function P(){q.visit("/internal-warehouse-transfer")}return et(()=>{if(window.addEventListener("keydown",O),!s.transfer_date){const o=new Date,t=o.getFullYear(),e=String(o.getMonth()+1).padStart(2,"0"),a=String(o.getDate()).padStart(2,"0");s.transfer_date=`${t}-${e}-${a}`}}),pt(()=>{window.removeEventListener("keydown",O)}),(o,t)=>(r(),st(xt,null,{default:yt(()=>[n("div",vt,[n("div",Dt,[n("button",{onClick:P,class:"text-blue-500 hover:underline"},t[5]||(t[5]=[n("i",{class:"fa fa-arrow-left"},null,-1),C(" Kembali")])),n("h1",It,[t[6]||(t[6]=n("i",{class:"fa fa-exchange-alt text-blue-500"},null,-1)),C(" "+m(x.value?"Edit Internal Warehouse Transfer":"Buat Internal Warehouse Transfer"),1)]),x.value?(r(),u("div",qt,[n("button",{onClick:ft,class:"bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition"},t[7]||(t[7]=[n("i",{class:"fa fa-trash mr-2"},null,-1),C("Hapus ")]))])):f("",!0)]),n("form",{onSubmit:ot(_t,["prevent"]),class:"bg-white rounded-lg shadow-lg p-6 space-y-6"},[n("div",St,[n("div",null,[t[8]||(t[8]=n("label",{class:"block text-sm font-medium text-gray-700"},"Tanggal Transfer",-1)),h(n("input",{type:"date","onUpdate:modelValue":t[0]||(t[0]=e=>i(s).transfer_date=e),class:"mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500",required:""},null,512),[[b,i(s).transfer_date]]),i(s).errors.transfer_date?(r(),u("div",$t,m(i(s).errors.transfer_date),1)):f("",!0)]),n("div",null,[t[10]||(t[10]=n("label",{class:"block text-sm font-medium text-gray-700"},"Outlet",-1)),h(n("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>i(s).outlet_id=e),class:"mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500",required:"",disabled:c.user_outlet_id!==1},[t[9]||(t[9]=n("option",{value:""},"Pilih Outlet",-1)),(r(!0),u(w,null,k(c.outlets,e=>(r(),u("option",{key:e.id_outlet,value:e.id_outlet},m(e.nama_outlet),9,Ct))),128))],8,Bt),[[N,i(s).outlet_id]]),i(s).errors.outlet_id?(r(),u("div",Nt,m(i(s).errors.outlet_id),1)):f("",!0)]),n("div",null,[t[12]||(t[12]=n("label",{class:"block text-sm font-medium text-gray-700"},"Departemen Asal",-1)),h(n("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>i(s).warehouse_outlet_from_id=e),class:"mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500",required:"",disabled:!i(s).outlet_id},[t[11]||(t[11]=n("option",{value:""},"Pilih Departemen Asal",-1)),(r(!0),u(w,null,k(S.value,e=>(r(),u("option",{key:e.id,value:e.id},m(e.name),9,Ut))),128))],8,Tt),[[N,i(s).warehouse_outlet_from_id]]),i(s).errors.warehouse_outlet_from_id?(r(),u("div",Vt,m(i(s).errors.warehouse_outlet_from_id),1)):f("",!0)]),n("div",null,[t[14]||(t[14]=n("label",{class:"block text-sm font-medium text-gray-700"},"Departemen Tujuan",-1)),h(n("select",{"onUpdate:modelValue":t[3]||(t[3]=e=>i(s).warehouse_outlet_to_id=e),class:"mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500",required:"",disabled:!i(s).outlet_id},[t[13]||(t[13]=n("option",{value:""},"Pilih Departemen Tujuan",-1)),(r(!0),u(w,null,k($.value,e=>(r(),u("option",{key:e.id,value:e.id},m(e.name),9,Mt))),128))],8,Et),[[N,i(s).warehouse_outlet_to_id]]),i(s).errors.warehouse_outlet_to_id?(r(),u("div",At,m(i(s).errors.warehouse_outlet_to_id),1)):f("",!0)])]),n("div",null,[t[15]||(t[15]=n("label",{class:"block text-sm font-medium text-gray-700"},"Keterangan",-1)),h(n("textarea",{"onUpdate:modelValue":t[4]||(t[4]=e=>i(s).notes=e),class:"mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"},null,512),[[b,i(s).notes]]),i(s).errors.notes?(r(),u("div",jt,m(i(s).errors.notes),1)):f("",!0)]),n("div",null,[t[20]||(t[20]=n("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Detail Item",-1)),L.value?f("",!0):(r(),u("div",Ft," Pilih outlet, departemen asal, dan departemen tujuan terlebih dahulu, dan pastikan departemen asal dan tujuan tidak sama. ")),n("div",{class:nt(["overflow-x-auto",{"pointer-events-none opacity-60":!L.value}])},[n("table",Kt,[t[18]||(t[18]=n("thead",{class:"bg-gradient-to-r from-blue-50 to-blue-100"},[n("tr",null,[n("th",{class:"px-3 py-2 text-left text-xs font-bold text-blue-700 uppercase tracking-wider"},"Item"),n("th",{class:"px-3 py-2 text-left text-xs font-bold text-blue-700 uppercase tracking-wider"},"Qty"),n("th",{class:"px-3 py-2 text-left text-xs font-bold text-blue-700 uppercase tracking-wider"},"Unit"),n("th",{class:"px-3 py-2 text-left text-xs font-bold text-blue-700 uppercase tracking-wider"},"Note"),n("th",{class:"px-3 py-2"})])],-1)),n("tbody",null,[(r(!0),u(w,null,k(i(s).items,(e,a)=>(r(),u("tr",{key:e._rowKey||a},[n("td",Ot,[n("div",Lt,[h(n("input",{id:`item-input-${a}`,type:"text","onUpdate:modelValue":l=>e.item_name=l,onInput:l=>K(a,l),onFocus:l=>K(a,l),onBlur:l=>dt(a),onKeydown:[T(l=>B(a,l),["down"]),T(l=>B(a,l),["up"]),T(l=>B(a,l),["enter"]),T(l=>B(a,l),["esc"])],class:"w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:"",autocomplete:"off",placeholder:"Cari nama item..."},null,40,Pt),[[b,e.item_name]]),(r(),st(bt,{to:"body"},[e.showDropdown&&e.suggestions&&e.suggestions.length>0?(r(),u("div",{key:0,style:wt(ct(a)),id:`autocomplete-dropdown-${a}`,class:"fixed z-[9999] bg-white border border-blue-200 rounded shadow max-w-xs w-[260px] max-h-96 overflow-auto mt-1"},[(r(!0),u(w,null,k(e.suggestions,(l,_)=>(r(),u("div",{key:l.id,id:`autocomplete-item-${a}-${_}`,onMousedown:ot(D=>F(a,l),["prevent"]),class:nt(["px-3 py-2 flex justify-between items-center cursor-pointer",e.highlightedIndex===_?"bg-blue-100":"hover:bg-blue-50"])},[n("div",null,[n("div",zt,m(l.name),1),n("div",Ht,m(l.sku),1)]),n("div",Wt,m(l.unit),1)],42,Qt))),128))],12,Gt)):f("",!0)])),e.loading?(r(),u("div",Yt,t[16]||(t[16]=[n("i",{class:"fa fa-spinner fa-spin text-blue-400"},null,-1)]))):f("",!0),i(s).warehouse_outlet_from_id?f("",!0):(r(),u("div",Jt," Pilih departemen asal terlebih dahulu untuk mencari item. ")),e.stock?(r(),u("div",Rt," Stok: "+m(ut(e)),1)):f("",!0)]),i(s).errors[`items.${a}.item_id`]?(r(),u("div",Zt,m(i(s).errors[`items.${a}.item_id`]),1)):f("",!0)]),n("td",Xt,[h(n("input",{type:"number",min:"0.01",step:"0.01","onUpdate:modelValue":l=>e.qty=l,class:"w-full rounded border-gray-300",required:""},null,8,te),[[b,e.qty]]),i(s).errors[`items.${a}.qty`]?(r(),u("div",ee,m(i(s).errors[`items.${a}.qty`]),1)):f("",!0)]),n("td",se,[e.available_units&&e.available_units.length?h((r(),u("select",{key:0,"onUpdate:modelValue":l=>e.selected_unit=l,onChange:l=>mt(a,l),class:"w-full rounded border-gray-300"},[(r(!0),u(w,null,k(e.available_units,l=>(r(),u("option",{key:l,value:l},m(l),9,ne))),128))],40,oe)),[[N,e.selected_unit]]):h((r(),u("input",{key:1,type:"text","onUpdate:modelValue":l=>e.unit=l,class:"w-full rounded border-gray-300",required:""},null,8,le)),[[b,e.unit]]),i(s).errors[`items.${a}.unit`]?(r(),u("div",ae,m(i(s).errors[`items.${a}.unit`]),1)):f("",!0)]),n("td",ie,[h(n("input",{type:"text","onUpdate:modelValue":l=>e.note=l,class:"w-full rounded border-gray-300"},null,8,re),[[b,e.note]])]),n("td",ue,[n("button",{type:"button",onClick:l=>it(a),class:"text-red-500 hover:text-red-700",disabled:i(s).items.length===1},t[17]||(t[17]=[n("i",{class:"fa fa-trash"},null,-1)]),8,de)])]))),128))])])],2),n("div",{class:"mt-4"},[n("button",{type:"button",onClick:at,class:"bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition"},t[19]||(t[19]=[n("i",{class:"fa fa-plus mr-2"},null,-1),C("Tambah Item ")]))])]),n("div",me,[n("button",{type:"button",onClick:P,class:"bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"}," Batal "),n("button",{type:"submit",disabled:i(s).processing,class:"bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition disabled:opacity-50"},m(i(s).processing?"Menyimpan...":x.value?"Update":"Simpan"),9,ce)])],32)])]),_:1}))}};export{ve as default};
