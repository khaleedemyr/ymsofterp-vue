import{r as n,w as _,b as S,A as N,B as s,L as i,E as B,D as t,l as U,G as V,F as z,M as G,H as P,J as H,N as W,T as A}from"./vendor-vue-g7iCcTkf.js";import{S as b}from"./app-DlrnVByK.js";import{a as I}from"./vendor-utils-CpgP2uT4.js";import"./vendor-charts-CuqD4wLC.js";const J={key:0,class:"fixed inset-0 z-[10000] flex items-center justify-center bg-black/40"},q={class:"bg-white rounded-xl shadow-lg w-full max-w-lg p-6 relative"},K={class:"mb-4 flex gap-2 items-center"},Q={class:"flex flex-col items-center"},X={key:0},Y={key:1},Z={class:"mt-4"},ee={class:"flex flex-wrap gap-3"},te=["src"],oe=["src"],ae=["onClick"],se={class:"mt-4"},ie={class:"flex justify-end gap-2 mt-6"},le=["disabled"],ne={key:0,class:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},ve={__name:"GoodReceiveModal",props:{show:Boolean,po:Object},emits:["close","uploaded"],setup(k,{emit:F}){const w=k,C=F,r=n("photo"),l=n([]),m=n(""),p=n(!1),g=n(!1),c=n(null),R=n(null);let d=null,v=null,h=[];const f=n("environment");_(()=>w.show,async o=>{o?(l.value=[],m.value="",await y()):x()}),S(()=>{x()});async function y(){x();try{d=await navigator.mediaDevices.getUserMedia({video:{facingMode:f.value},audio:r.value==="video"}),c.value&&(c.value.srcObject=d)}catch{b.fire("Error","Tidak bisa mengakses kamera","error")}}function x(){d&&(d.getTracks().forEach(o=>o.stop()),d=null),c.value&&(c.value.srcObject=null)}_(r,async()=>{w.show&&await y()});function M(){const o=c.value,e=R.value;if(!o||!e)return;e.width=o.videoWidth,e.height=o.videoHeight,e.getContext("2d").drawImage(o,0,0,e.width,e.height),e.toBlob(u=>{const j=new File([u],`photo-${Date.now()}.jpg`,{type:"image/jpeg"}),O=URL.createObjectURL(u);l.value.push({file:j,preview:O,type:"image/jpeg"})},"image/jpeg",.95)}function $(){d&&(h=[],v=new MediaRecorder(d,{mimeType:"video/webm"}),v.ondataavailable=o=>{o.data.size>0&&h.push(o.data)},v.onstop=()=>{const o=new Blob(h,{type:"video/webm"}),e=new File([o],`video-${Date.now()}.webm`,{type:"video/webm"}),a=URL.createObjectURL(o);l.value.push({file:e,preview:a,type:"video/webm"})},v.start(),g.value=!0)}function D(){v&&g.value&&(v.stop(),g.value=!1)}function L(o){const e=l.value[o];e&&e.preview&&URL.revokeObjectURL(e.preview),l.value.splice(o,1)}function T(){f.value=f.value==="environment"?"user":"environment",y()}async function E(){var o,e;if(!l.value.length){b.fire("Error","Minimal 1 foto/video wajib diupload","error");return}p.value=!0;try{const a=new FormData;l.value.forEach(({file:u})=>{a.append("receive_files[]",u)}),a.append("receive_notes",m.value),a.append("camera_facing_mode",f.value),await I.post(`/api/purchase-orders/${w.po.id}/receive`,a,{headers:{"Content-Type":"multipart/form-data"}}),b.fire("Sukses","Bukti penerimaan berhasil diupload","success"),C("uploaded"),C("close")}catch(a){b.fire("Error",((e=(o=a.response)==null?void 0:o.data)==null?void 0:e.message)||"Gagal upload bukti penerimaan","error")}finally{p.value=!1}}return(o,e)=>(s(),N(A,{to:"body"},[k.show?(s(),i("div",J,[t("div",q,[t("button",{onClick:e[0]||(e[0]=a=>o.$emit("close")),class:"absolute top-3 right-3 text-gray-400 hover:text-gray-600"},e[5]||(e[5]=[t("i",{class:"fas fa-times text-lg"},null,-1)])),e[10]||(e[10]=t("h3",{class:"text-lg font-medium mb-4"},"Upload Bukti Penerimaan Barang",-1)),t("div",K,[t("button",{class:U(["px-3 py-1 rounded",r.value==="photo"?"bg-indigo-500 text-white":"bg-gray-100 text-gray-700"]),onClick:e[1]||(e[1]=a=>r.value="photo")},"Foto",2),t("button",{class:U(["px-3 py-1 rounded",r.value==="video"?"bg-indigo-500 text-white":"bg-gray-100 text-gray-700"]),onClick:e[2]||(e[2]=a=>r.value="video")},"Video",2),t("button",{onClick:T,class:"ml-4 px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 flex items-center gap-1"},e[6]||(e[6]=[t("i",{class:"fas fa-sync-alt"},null,-1),V(" Switch Camera ")]))]),t("div",Q,[t("video",{ref_key:"videoRef",ref:c,autoplay:"",playsinline:"",class:"rounded border mb-2 w-full max-w-md h-64 object-cover bg-black"},null,512),t("canvas",{ref_key:"canvasRef",ref:R,class:"hidden"},null,512),r.value==="photo"?(s(),i("div",X,[t("button",{onClick:M,class:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 mb-2"},"Capture Foto")])):(s(),i("div",Y,[g.value?(s(),i("button",{key:1,onClick:D,class:"px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 mb-2"},"Stop Rekam")):(s(),i("button",{key:0,onClick:$,class:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 mb-2"},"Mulai Rekam"))]))]),t("div",Z,[e[8]||(e[8]=t("div",{class:"font-medium mb-2"},"Preview Bukti:",-1)),t("div",ee,[(s(!0),i(z,null,G(l.value,(a,u)=>(s(),i("div",{key:u,class:"relative"},[a.type.startsWith("image/")?(s(),i("img",{key:0,src:a.preview,class:"w-24 h-24 object-cover rounded border"},null,8,te)):(s(),i("video",{key:1,controls:"",src:a.preview,class:"w-24 h-24 object-cover rounded border"},null,8,oe)),t("button",{onClick:j=>L(u),class:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center"},e[7]||(e[7]=[t("i",{class:"fas fa-times"},null,-1)]),8,ae)]))),128))])]),t("div",se,[e[9]||(e[9]=t("label",{class:"block text-sm font-medium mb-1"},"Catatan (opsional)",-1)),P(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=a=>m.value=a),class:"w-full border rounded p-2",rows:"2",placeholder:"Catatan penerimaan..."},null,512),[[H,m.value]])]),t("div",ie,[t("button",{onClick:e[4]||(e[4]=a=>o.$emit("close")),class:"px-4 py-2 text-gray-700 bg-gray-100 rounded hover:bg-gray-200"},"Batal"),t("button",{onClick:E,disabled:p.value,class:"px-4 py-2 text-white bg-indigo-500 rounded hover:bg-indigo-600 flex items-center gap-2"},[p.value?(s(),i("div",ne)):B("",!0),t("span",null,W(p.value?"Mengupload...":"Upload"),1)],8,le)])])])):B("",!0)]))}};export{ve as default};
