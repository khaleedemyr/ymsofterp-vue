import{u as C,S as l}from"./app-HnvVj7H8.js";import A from"./KanbanColumn-BJA8zyRU.js";import{a as f}from"./vendor-utils-CpgP2uT4.js";import{r as b,c as F,w as R,L as P,B as h,A as I,E as y,F as G,M as K,x as $,C as M,D as g,N as _,Q as D}from"./vendor-vue-g7iCcTkf.js";import j from"./CreateTaskModal-OOkpKFDD.js";import{_ as V}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./vendor-charts-CuqD4wLC.js";import"./KanbanCard-MQEbW-Kv.js";import"./CommentModal-nj5ma9A2.js";import"./CameraModal-UOq4SzNh.js";import"./vendor-ui-CrPgGUUb.js";import"./AssignMemberModal-Dve_0Ypd.js";import"./ActionPlanButton-BZFhsrPU.js";import"./ActionPlanList-XU2D29cy.js";import"./id-C4ThNj35.js";import"./AddRetailItem-bAyqTIgU.js";import"./RetailList-nbVbAXBp.js";import"./TimelineModal-wu9gKOdI.js";import"./PurchaseRequisitionListModal-EAppMp0P.js";import"./PurchaseRequisitionForm-DU0_wEkc.js";import"./PurchaseOrderTypeModal-DxXPU3QF.js";import"./BiddingStartModal-B0A-mwWr.js";import"./BiddingPrintPreviewModal-BsohxcIw.js";import"./BiddingList-BgSUJo10.js";import"./BiddingSupplierInputModal-1EFofvlN.js";import"./PurchaseOrderListModal-rUzR0XuH.js";import"./PurchaseOrderDetailModal-Bg7r6FM9.js";import"./GoodReceiveModal-0xyaL7ZW.js";import"./EvidenceModal-CK0IAd-I.js";import"./EvidenceList-eDE95GxJ.js";function L(){const u=b([]),i=F(()=>{const t={ToDo:[],PR:[],PO:[],InProgress:[],InReview:[],Done:[]};console.log("Grouping tasks:",u.value);for(const a of u.value){let e=a.status;switch(console.log("Processing task:",a.id,"with status:",e),e){case"TASK":e="ToDo";break;case"PR":e="PR";break;case"PO":e="PO";break;case"IN_PROGRESS":e="InProgress";break;case"IN_REVIEW":e="InReview";break;case"DONE":e="Done";break;default:console.warn("Unknown status:",e,"for task:",a.id),e="ToDo"}console.log("Mapped status:",e,"for task:",a.id),t[e]||(t[e]=[]),t[e].push(a)}return console.log("Final grouped tasks:",t),t});async function c({outlet:t,ruko:a}){console.log("fetchTasks called with:",{outlet:t,ruko:a});try{if(!t){console.log("No outlet provided, clearing tasks"),u.value=[];return}const e={id_outlet:t};t==1&&a&&(e.id_ruko=a),console.log("Fetching tasks with params:",e);const{data:p}=await f.get("/api/maintenance-order",{params:e});console.log("Tasks fetched:",p),u.value=Array.isArray(p)?p:[],console.log("Tasks updated, current state:",u.value)}catch(e){throw console.error("Error fetching tasks:",e),u.value=[],e}}async function T({taskId:t,toStatus:a,filter:e}){var p;console.log("onDropTask called:",{taskId:t,toStatus:a,filter:e});try{if(!t||t==="undefined"||!a){console.error("Invalid task data:",{taskId:t,toStatus:a});return}let n=a;switch(a){case"ToDo":n="TASK";break;case"PR":n="PR";break;case"PO":n="PO";break;case"InProgress":n="IN_PROGRESS";break;case"InReview":n="IN_REVIEW";break;case"Done":n="DONE";break;default:console.error("Invalid status:",a);return}console.log("Updating task status:",{taskId:t,backendStatus:n});const d=await f.patch(`/api/maintenance-order/${t}`,{status:n});if(!d.data.success)throw new Error(d.data.error||"Failed to update task status");console.log("Task status updated successfully"),await c(e||{})}catch(n){throw console.error("Error in onDropTask:",n),console.error("Error details:",(p=n.response)==null?void 0:p.data),n}}return{tasks:u,tasksByStatus:i,fetchTasks:c,onDropTask:T}}const S={class:"kanban-board flex flex-col md:flex-row gap-6 overflow-x-auto py-6 px-2 md:px-8 bg-gradient-to-br from-blue-50 via-white to-purple-100 h-[calc(100vh-12rem)]"},U={class:"flex items-center justify-center gap-2"},W={class:"bg-blue-100 text-blue-700 text-xs font-bold rounded-full px-2 py-0.5"},q={__name:"KanbanBoard",props:{outlet:[String,Number],ruko:[String,Number]},setup(u){const i=u,{t:c}=C(),T=[{status:"ToDo",title:c("kanban.todo")},{status:"PR",title:c("kanban.pr")},{status:"PO",title:c("kanban.po")},{status:"InProgress",title:c("kanban.in_progress")},{status:"InReview",title:c("kanban.in_review")},{status:"Done",title:c("kanban.done")}],{tasks:t,tasksByStatus:a,fetchTasks:e,onDropTask:p}=L(),n=b(!1),d=b(i.outlet),E=b(i.ruko);async function x({taskId:o,toStatus:s}){if(console.log("KanbanBoard onDropTask:",{taskId:o,toStatus:s}),!o||!s){console.error("Invalid drop data:",{taskId:o,toStatus:s}),l.fire("Error","Data task tidak valid","error");return}if(s==="PO")try{if((await f.get(`/api/maintenance-tasks/${o}/purchase-requisitions`)).data.some(m=>m.status==="DRAFT")){l.fire({title:"Tidak dapat memindahkan task",text:"Task tidak dapat dipindahkan ke PO karena masih ada PR dengan status DRAFT",icon:"warning"});return}}catch(r){console.error("Error checking PR status:",r),l.fire("Error","Gagal memeriksa status PR","error");return}if(s==="InProgress")try{const v=(await f.get(`/api/maintenance-tasks/${o}/purchase-orders`)).data.filter(m=>m.status==="DRAFT");if(v.length>0){const m=v.map(B=>B.po_number).join(", ");l.fire({title:"Tidak dapat memindahkan task",html:`Task tidak dapat dipindahkan ke In Progress karena masih ada PO dengan status DRAFT:<br><br>${m}`,icon:"warning"});return}}catch(r){console.error("Error checking PO status:",r),l.fire("Error","Gagal memeriksa status PO","error");return}if(s==="Done")try{const{data:r}=await f.get(`/api/maintenance-evidence/${o}`);if(!r||r.length===0){l.fire("Tidak bisa selesai","Harus upload dulu bukti pekerjaan telah selesai.","warning");return}}catch{l.fire("Error","Gagal memeriksa evidence","error");return}try{p({taskId:o,toStatus:s,filter:{outlet:i.outlet,ruko:i.ruko}}).then(()=>{console.log("Task updated successfully:",{taskId:o,toStatus:s}),k()}).catch(r=>{console.error("Error updating task:",r),l.fire("Error","Gagal memperbarui status task","error")})}catch(r){console.error("Error in onDropTask:",r),l.fire("Error","Terjadi kesalahan saat memperbarui task","error")}}async function k(){console.log("refreshTasks called with:",{outlet:i.outlet,ruko:i.ruko});try{await e({outlet:i.outlet,ruko:i.ruko}),console.log("Tasks after refresh:",t.value),console.log("Tasks by status:",a)}catch(o){console.error("Error in refreshTasks:",o)}}R(()=>i.outlet,(o,s)=>{console.log("Outlet changed:",{old:s,new:o}),d.value=o,k()},{immediate:!0}),R(()=>i.ruko,(o,s)=>{console.log("Ruko changed:",{old:s,new:o}),E.value=o,k()},{immediate:!0});function O(){if(!i.outlet){l.fire("Error","Pilih outlet terlebih dahulu!","error");return}if(i.outlet==1&&!i.ruko){l.fire("Error","Pilih ruko terlebih dahulu!","error");return}n.value=!0}const N=()=>{k()};return(o,s)=>(h(),P("div",S,[(h(),P(G,null,K(T,(r,w)=>$(A,{key:r.status,title:r.title,status:r.status,tasks:D(a)[r.status]||[],count:(D(a)[r.status]||[]).length,onDropTask:x,onTaskMoved:k},{header:M(()=>[g("div",U,[g("span",null,_(r.title),1),g("span",W,_((D(a)[r.status]||[]).length),1),w===0?(h(),P("button",{key:0,onClick:O,class:"ml-2 text-blue-500 hover:text-blue-700 text-lg rounded-full p-1 bg-white shadow transition-all",title:"Tambah Task"},s[1]||(s[1]=[g("i",{class:"fas fa-plus"},null,-1)]))):y("",!0)])]),_:2},1032,["title","status","tasks","count"])),64)),n.value?(h(),I(j,{key:0,outlet:d.value,ruko:E.value,onClose:s[0]||(s[0]=r=>n.value=!1),onTaskCreated:N},null,8,["outlet","ruko"])):y("",!0)]))}},De=V(q,[["__scopeId","data-v-1d37b014"]]);export{De as default};
