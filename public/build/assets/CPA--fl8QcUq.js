import{r as d,A as ae,B as l,C as oe,D as e,L as r,E as h,G as m,N as n,l as H,F as U,M as S,H as $,J as B,O as le,W as I}from"./vendor-vue-g7iCcTkf.js";import{A as re}from"./AppLayout-1Wm1ZPw9.js";import{S as C}from"./app-BPKNzj_F.js";import{a as ne}from"./vendor-utils-CpgP2uT4.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ProfileUpdateModal-CVHTvH7j.js";import"./InputLabel-Bg0AMQZ3.js";import"./PrimaryButton-BbBAD9SX.js";import"./TextInput-B7P_xVe4.js";import"./vendor-charts-CuqD4wLC.js";const ie={class:"w-full py-8 px-4"},de={class:"max-w-7xl mx-auto"},ue={class:"flex items-center justify-between mb-8"},ce={class:"flex items-center gap-4"},pe={class:"text-gray-600 mt-2"},me={class:"bg-white rounded-2xl shadow-lg p-6 mb-8 border-l-4 border-purple-500"},ge={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},ve={class:"text-sm text-gray-600"},fe={class:"text-sm text-gray-600"},be={class:"text-sm text-gray-600"},xe={class:"text-sm text-gray-600"},ye={class:"text-sm text-gray-600"},he={class:"space-y-1"},we={key:0,class:"space-y-8"},ke={class:"flex items-start justify-between mb-6"},_e={class:"flex-1"},Ce={class:"text-xl font-bold text-gray-800 mb-2"},Ae={class:"bg-gray-50 border border-gray-200 rounded-lg p-4"},Pe={class:"space-y-2"},De={class:"text-gray-800"},je={class:"text-gray-800"},Fe={class:"text-gray-800"},Ee={key:0},Ue={class:"text-gray-800"},Se={key:0,class:"mt-4"},$e={class:"flex gap-2 mt-2"},Be=["src","alt","onClick"],Me={class:"flex items-center justify-between"},Te={class:"text-sm text-gray-600"},Ve={class:"space-y-6"},ze=["onUpdate:modelValue"],Ne={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Le={class:"relative"},Re={class:"relative"},Oe=["onUpdate:modelValue","onInput","onFocus","onBlur"],Ge=["onClick"],We={key:0,class:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"},He=["onClick"],Ie={class:"flex items-center gap-3"},Je={key:0,class:"w-8 h-8 rounded-full overflow-hidden"},Ke=["src","alt"],Qe={key:1,class:"w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold"},Ye={class:"font-medium text-gray-800"},Xe={key:0,class:"text-sm text-gray-500"},Ze={key:1,class:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg"},qe=["onUpdate:modelValue"],et={class:"flex gap-2 mb-3"},tt=["onClick"],st=["for"],at=["onChange","id"],ot={key:0,class:"mt-4"},lt={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},rt=["src","alt","onClick"],nt=["onClick"],it={class:"text-xs text-gray-500 mt-1 truncate"},dt=["onUpdate:modelValue"],ut={key:1,class:"mt-8 flex justify-center"},ct=["disabled"],pt={key:0,class:"fa-solid fa-spinner fa-spin text-xl"},mt={key:1,class:"fa-solid fa-save text-xl"},gt={key:2,class:"text-center py-12"},vt=["src"],ft={key:1,class:"fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center"},bt={class:"bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden"},xt={class:"p-4"},yt={class:"relative bg-black rounded-lg overflow-hidden mb-4",style:{"aspect-ratio":"16/9"}},ht={key:0,class:"absolute inset-0 flex items-center justify-center bg-gray-800"},$t={__name:"CPA",props:{inspection:Object,findings:Array,users:Array},setup(i){const f=i,b=d({}),E=d(!1),M=d(!1),T=d(""),u=d({});d(!1);const x=d({}),A=d({}),D=d({}),V=d(!1),j=d(null),k=d(null),z=d(!1);let w=null;const F=d("environment");function L(a){T.value=a,M.value=!0}function R(){M.value=!1,T.value=""}function J(a,t){const c=Array.from(a.target.files);u.value[t]||(u.value[t]=[]),c.forEach(p=>{if(p.type.startsWith("image/")){const s=new FileReader;s.onload=g=>{u.value[t].push({file:p,preview:g.target.result,name:p.name})},s.readAsDataURL(p)}})}function K(a,t){u.value[a].splice(t,1)}async function Q(a){j.value=a,V.value=!0,await O()}function N(){V.value=!1,j.value=null,w&&(w.getTracks().forEach(a=>a.stop()),w=null),z.value=!1}async function O(){try{w&&w.getTracks().forEach(t=>t.stop());const a={video:{facingMode:F.value,width:{ideal:1280},height:{ideal:720}}};try{w=await navigator.mediaDevices.getUserMedia(a)}catch{F.value=F.value==="user"?"environment":"user",w=await navigator.mediaDevices.getUserMedia({video:{facingMode:F.value,width:{ideal:1280},height:{ideal:720}}})}k.value&&(k.value.srcObject=w,k.value.onloadedmetadata=()=>{z.value=!0})}catch(a){console.error("Error accessing camera:",a),C.fire("Error","Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera.","error")}}async function Y(){F.value=F.value==="user"?"environment":"user",await O()}function X(){if(!k.value||!w){C.fire("Error","Kamera belum siap. Silakan tunggu sebentar.","error");return}try{const a=document.createElement("canvas");a.width=k.value.videoWidth,a.height=k.value.videoHeight,a.getContext("2d").drawImage(k.value,0,0);const c=a.toDataURL("image/jpeg",.9);Z(c)}catch(a){console.error("Error capturing photo:",a),C.fire("Error","Gagal mengambil foto. Silakan coba lagi.","error")}}async function Z(a){if(j.value)try{const c=await(await fetch(a)).blob(),p=new File([c],`photo_${Date.now()}.jpg`,{type:"image/jpeg"});u.value[j.value]||(u.value[j.value]=[]),u.value[j.value].push({file:p,preview:a,name:p.name}),N()}catch(t){console.error("Error processing photo:",t),C.fire("Error","Gagal memproses foto","error")}}(()=>{f.findings.forEach(a=>{b.value[a.id]={action_plan:"",responsible_person:"",due_date:"",notes:""},x.value[a.id]=!1,A.value[a.id]=f.users||[],D.value[a.id]=""})})();const q=async()=>{var c,p;const a=[];if(f.findings.forEach((s,g)=>{const _=b.value[s.id],v=u.value[s.id]||[];(!_.action_plan||!_.responsible_person||!_.due_date)&&a.push(`Finding #${g+1}: Please fill in action plan, responsible person and due date`),v.length===0&&a.push(`Finding #${g+1}: Please upload at least one documentation image`)}),a.length>0){C.fire({icon:"warning",title:"Validation Error",html:a.join("<br>")});return}if((await C.fire({title:"Save All CPA?",text:`Are you sure you want to save CPA for ${f.findings.length} finding(s)?`,icon:"question",showCancelButton:!0,confirmButtonColor:"#7c3aed",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, Save All!",cancelButtonText:"Cancel"})).isConfirmed){E.value=!0;try{for(const s of f.findings){const g=b.value[s.id],_=u.value[s.id]||[],v=new FormData;v.append("inspection_detail_id",s.id),v.append("action_plan",g.action_plan),v.append("responsible_person",g.responsible_person),v.append("due_date",g.due_date),v.append("notes",g.notes||""),_.forEach((y,P)=>{v.append(`documentation[${P}]`,y.file)});const o=await ne.post(route("inspections.cpa.store",f.inspection.id),v,{headers:{"Content-Type":"multipart/form-data"}});if(!o.data.success)throw new Error(o.data.message||"Failed to save CPA")}C.fire({icon:"success",title:"Success!",text:`All CPA saved successfully for ${f.findings.length} finding(s)!`,confirmButtonColor:"#10b981",timer:2e3,timerProgressBar:!0}).then(()=>{I.visit(route("inspections.index"))}),f.findings.forEach(s=>{u.value[s.id]=[]})}catch(s){console.error("CPA Save Error:",s),C.fire({icon:"error",title:"Error",text:((p=(c=s.response)==null?void 0:c.data)==null?void 0:p.message)||s.message||"Failed to save some CPA. Please check and try again.",confirmButtonColor:"#ef4444"})}finally{E.value=!1}}};function ee(a,t){D.value[a]=t,t.length>0?(A.value[a]=f.users.filter(c=>c.nama_lengkap.toLowerCase().includes(t.toLowerCase())),x.value[a]=!0):(A.value[a]=f.users||[],x.value[a]=!1)}function te(a,t){b.value[a].responsible_person=t.nama_lengkap,D.value[a]=t.nama_lengkap,x.value[a]=!1}function G(a){x.value[a]=!x.value[a],x.value[a]&&(A.value[a]=f.users||[])}function se(a){x.value[a]=!1}const W=()=>{I.visit(route("inspections.index"))};return(a,t)=>(l(),ae(re,{title:"Corrective and Preventive Action (CPA)"},{default:oe(()=>{var c,p;return[e("div",ie,[e("div",de,[e("div",ue,[e("div",ce,[e("button",{onClick:W,class:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"},t[1]||(t[1]=[e("i",{class:"fa-solid fa-arrow-left text-xl"},null,-1)])),e("div",null,[t[2]||(t[2]=e("h1",{class:"text-3xl font-bold text-gray-800 flex items-center gap-3"},[e("i",{class:"fa-solid fa-clipboard-list text-purple-500"}),m(" Corrective and Preventive Action (CPA) ")],-1)),e("p",pe,n((c=i.inspection.outlet)==null?void 0:c.nama_outlet)+" - "+n(i.inspection.departemen),1)])])]),e("div",me,[e("div",ge,[e("div",null,[t[6]||(t[6]=e("h3",{class:"text-lg font-semibold text-gray-800 mb-2"},"Inspection Details",-1)),e("p",ve,[t[3]||(t[3]=e("strong",null,"Date:",-1)),m(" "+n(new Date(i.inspection.inspection_date).toLocaleDateString("id-ID")),1)]),e("p",fe,[t[4]||(t[4]=e("strong",null,"Guidance:",-1)),m(" "+n(((p=i.inspection.guidance)==null?void 0:p.title)||"-"),1)]),e("p",be,[t[5]||(t[5]=e("strong",null,"Status:",-1)),e("span",{class:H(["px-2 py-1 rounded-full text-xs font-semibold",i.inspection.status==="Completed"?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"])},n(i.inspection.status),3)])]),e("div",null,[t[9]||(t[9]=e("h3",{class:"text-lg font-semibold text-gray-800 mb-2"},"Findings Summary",-1)),e("p",xe,[t[7]||(t[7]=e("strong",null,"Total Findings:",-1)),m(" "+n(i.findings.length),1)]),e("p",ye,[t[8]||(t[8]=e("strong",null,"Score:",-1)),m(" "+n(i.inspection.score||0)+"%",1)])]),e("div",null,[t[10]||(t[10]=e("h3",{class:"text-lg font-semibold text-gray-800 mb-2"},"Auditees",-1)),e("div",he,[(l(!0),r(U,null,S(i.inspection.auditees,s=>(l(),r("div",{key:s.id,class:"text-sm text-gray-600"},n(s.nama_lengkap),1))),128))])])])]),i.findings.length>0?(l(),r("div",we,[(l(!0),r(U,null,S(i.findings,s=>{var g,_,v;return l(),r("div",{key:s.id,class:"bg-white rounded-2xl shadow-lg p-6 border border-gray-200"},[e("div",ke,[e("div",_e,[e("h3",Ce," Finding #"+n(i.findings.indexOf(s)+1),1),e("div",Ae,[t[17]||(t[17]=e("h4",{class:"font-semibold text-gray-800 mb-3"},"Finding Details:",-1)),e("div",Pe,[e("div",null,[t[11]||(t[11]=e("label",{class:"text-sm font-medium text-gray-500"},"Category",-1)),e("p",De,n(((g=s.category)==null?void 0:g.categories)||"-"),1)]),e("div",null,[t[12]||(t[12]=e("label",{class:"text-sm font-medium text-gray-500"},"Parameter Pemeriksaan",-1)),e("p",je,n(s.parameter_pemeriksaan||"-"),1)]),e("div",null,[t[13]||(t[13]=e("label",{class:"text-sm font-medium text-gray-500"},"Parameter",-1)),e("p",Fe,n(((_=s.parameter)==null?void 0:_.parameter)||"-"),1)]),s.notes?(l(),r("div",Ee,[t[14]||(t[14]=e("label",{class:"text-sm font-medium text-gray-500"},"Notes",-1)),e("p",Ue,n(s.notes),1)])):h("",!0)]),s.photo_paths&&s.photo_paths.length>0?(l(),r("div",Se,[t[15]||(t[15]=e("label",{class:"text-sm font-medium text-gray-500"},"Photo Evidence",-1)),e("div",$e,[(l(!0),r(U,null,S(s.photo_paths,(o,y)=>(l(),r("img",{key:y,src:`/storage/${o}`,alt:`Finding photo ${y+1}`,class:"w-16 h-16 object-cover rounded cursor-pointer hover:opacity-80 transition",onClick:P=>L(`/storage/${o}`)},null,8,Be))),128))])])):h("",!0),e("div",Me,[e("div",null,[e("span",{class:H(["px-3 py-1 rounded-full text-sm font-semibold",s.status==="Non-Compliance"?"bg-red-100 text-red-800":s.status==="Compliance"?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"])},n(s.status),3)]),e("div",Te,[t[16]||(t[16]=e("span",{class:"font-medium"},"Inspector:",-1)),m(" "+n(((v=s.created_by_user)==null?void 0:v.nama_lengkap)||"Unknown"),1)])])])])]),e("div",Ve,[e("div",null,[t[18]||(t[18]=e("label",{class:"block text-sm font-semibold text-gray-700 mb-2"}," Action Plan * ",-1)),$(e("textarea",{"onUpdate:modelValue":o=>b.value[s.id].action_plan=o,rows:"4",class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",placeholder:"Describe the action plan to address this finding..."},null,8,ze),[[B,b.value[s.id].action_plan]])]),e("div",Ne,[e("div",Le,[t[21]||(t[21]=e("label",{class:"block text-sm font-semibold text-gray-700 mb-2"}," Responsible Person * ",-1)),e("div",Re,[$(e("input",{"onUpdate:modelValue":o=>D.value[s.id]=o,onInput:o=>ee(s.id,o.target.value),onFocus:o=>G(s.id),onBlur:o=>a.setTimeout(()=>se(s.id),200),type:"text",class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",placeholder:"Search responsible person..."},null,40,Oe),[[B,D.value[s.id]]]),e("button",{type:"button",onClick:o=>G(s.id),class:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"},t[19]||(t[19]=[e("i",{class:"fa-solid fa-chevron-down"},null,-1)]),8,Ge)]),x.value[s.id]&&A.value[s.id].length>0?(l(),r("div",We,[(l(!0),r(U,null,S(A.value[s.id],o=>{var y,P;return l(),r("div",{key:o.id,onClick:kt=>te(s.id,o),class:"px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"},[e("div",Ie,[o.avatar?(l(),r("div",Je,[e("img",{src:`/storage/${o.avatar}`,alt:o.nama_lengkap,class:"w-full h-full object-cover"},null,8,Ke)])):(l(),r("div",Qe,n(((y=o.nama_lengkap)==null?void 0:y.charAt(0))||"U"),1)),e("div",null,[e("p",Ye,n(o.nama_lengkap),1),(P=o.jabatan)!=null&&P.nama_jabatan?(l(),r("p",Xe,n(o.jabatan.nama_jabatan),1)):h("",!0)])])],8,He)}),128))])):h("",!0),x.value[s.id]&&A.value[s.id].length===0&&D.value[s.id].length>0?(l(),r("div",Ze,t[20]||(t[20]=[e("div",{class:"px-4 py-3 text-gray-500 text-center"}," No users found ",-1)]))):h("",!0)]),e("div",null,[t[22]||(t[22]=e("label",{class:"block text-sm font-semibold text-gray-700 mb-2"}," Due Date * ",-1)),$(e("input",{"onUpdate:modelValue":o=>b.value[s.id].due_date=o,type:"date",class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"},null,8,qe),[[B,b.value[s.id].due_date]])])]),e("div",null,[t[26]||(t[26]=e("label",{class:"block text-sm font-semibold text-gray-700 mb-2"}," Documentation * ",-1)),e("div",et,[e("button",{type:"button",onClick:o=>Q(s.id),class:"px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition flex items-center gap-2"},t[23]||(t[23]=[e("i",{class:"fa-solid fa-camera"},null,-1),m(" Camera ")]),8,tt),e("label",{for:`file-upload-${s.id}`,class:"px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition flex items-center gap-2 cursor-pointer"},t[24]||(t[24]=[e("i",{class:"fa-solid fa-upload"},null,-1),m(" Upload ")]),8,st),e("input",{type:"file",multiple:"",accept:"image/*",onChange:o=>J(o,s.id),class:"hidden",id:`file-upload-${s.id}`},null,40,at)]),u.value[s.id]&&u.value[s.id].length>0?(l(),r("div",ot,[e("div",lt,[(l(!0),r(U,null,S(u.value[s.id],(o,y)=>(l(),r("div",{key:y,class:"relative group"},[e("img",{src:o.preview,alt:o.name,class:"w-full h-24 object-cover rounded-lg border border-gray-200 cursor-pointer hover:shadow-lg transition",onClick:P=>L(o.preview)},null,8,rt),e("button",{onClick:P=>K(s.id,y),class:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition"},t[25]||(t[25]=[e("i",{class:"fa-solid fa-times"},null,-1)]),8,nt),e("p",it,n(o.name),1)]))),128))])])):h("",!0)]),e("div",null,[t[27]||(t[27]=e("label",{class:"block text-sm font-semibold text-gray-700 mb-2"}," Notes (Optional) ",-1)),$(e("textarea",{"onUpdate:modelValue":o=>b.value[s.id].notes=o,rows:"3",class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",placeholder:"Additional notes or comments..."},null,8,dt),[[B,b.value[s.id].notes]])])])])}),128))])):h("",!0),i.findings.length>0?(l(),r("div",ut,[e("button",{onClick:q,disabled:E.value,class:"px-8 py-4 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white rounded-xl font-medium transition flex items-center gap-3 text-lg"},[E.value?(l(),r("i",pt)):(l(),r("i",mt)),m(" "+n(E.value?"Saving All CPA...":"Save All CPA"),1)],8,ct)])):(l(),r("div",gt,[t[29]||(t[29]=e("i",{class:"fa-solid fa-clipboard-check text-6xl text-gray-300 mb-4"},null,-1)),t[30]||(t[30]=e("h3",{class:"text-lg font-semibold text-gray-500 mb-2"},"No Findings Found",-1)),t[31]||(t[31]=e("p",{class:"text-gray-400 mb-6"},"This inspection has no findings to input CPA for.",-1)),e("button",{onClick:W,class:"px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-medium transition"},t[28]||(t[28]=[e("i",{class:"fa-solid fa-arrow-left mr-2"},null,-1),m("Back to Inspections ")]))]))]),M.value?(l(),r("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75",onClick:R},[e("div",{class:"relative max-w-4xl max-h-[90vh] p-4",onClick:t[0]||(t[0]=le(()=>{},["stop"]))},[e("button",{onClick:R,class:"absolute -top-4 -right-4 bg-white rounded-full p-2 shadow-lg hover:bg-gray-100 transition-colors z-10"},t[32]||(t[32]=[e("i",{class:"fa-solid fa-times text-gray-600"},null,-1)])),e("img",{src:T.value,alt:"Finding documentation",class:"max-w-full max-h-full object-contain rounded-lg shadow-2xl"},null,8,vt)])])):h("",!0),V.value?(l(),r("div",ft,[e("div",bt,[e("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4"},[e("div",{class:"flex justify-between items-center"},[t[34]||(t[34]=e("h3",{class:"text-lg font-semibold flex items-center"},[e("i",{class:"fa-solid fa-camera mr-2"}),m(" Take Documentation Photo ")],-1)),e("button",{onClick:N,class:"text-white hover:text-gray-200 text-xl"},t[33]||(t[33]=[e("i",{class:"fa-solid fa-times"},null,-1)]))])]),e("div",xt,[e("div",yt,[e("video",{ref_key:"videoRef",ref:k,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-cover"},null,512),z.value?h("",!0):(l(),r("div",ht,t[35]||(t[35]=[e("div",{class:"text-white text-center"},[e("i",{class:"fa-solid fa-spinner fa-spin text-2xl mb-2"}),e("p",null,"Initializing camera...")],-1)])))]),e("div",{class:"flex items-center justify-between"},[e("button",{onClick:Y,class:"px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition flex items-center gap-2"},t[36]||(t[36]=[e("i",{class:"fa-solid fa-camera-rotate"},null,-1),m(" Switch Camera ")])),e("div",{class:"flex gap-3"},[e("button",{onClick:N,class:"px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium"}," Cancel "),e("button",{onClick:X,class:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium shadow-lg"},t[37]||(t[37]=[e("i",{class:"fa-solid fa-camera mr-2"},null,-1),m(" Capture ")]))])]),t[38]||(t[38]=e("div",{class:"text-center text-sm text-gray-500 mt-4"},[e("p",null,"Position the camera and press Capture to take a photo")],-1))])])])):h("",!0)])]}),_:1}))}};export{$t as default};
