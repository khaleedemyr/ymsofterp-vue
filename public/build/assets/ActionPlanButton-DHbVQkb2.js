import{r as i,c as X,b as Y,L as n,B as l,E as R,A as $,D as t,G as f,H as Z,J as ee,F as te,M as ae,T as P,N as L,l as se}from"./vendor-vue-g7iCcTkf.js";import{a as oe}from"./vendor-utils-CpgP2uT4.js";import{S as C}from"./app-5sHs3Z-e.js";import"./vendor-charts-CuqD4wLC.js";const le={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},ie={class:"bg-white rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto"},ne={class:"p-4"},re={class:"mb-4"},ue={class:"mb-4"},ce={class:"flex flex-wrap gap-2 mb-2"},de={class:"grid grid-cols-3 gap-2 mt-2"},ve=["src"],pe=["src"],fe=["onClick"],me={class:"p-4 border-t flex justify-end gap-2"},be=["disabled"],ge={key:0,class:"fas fa-spinner fa-spin mr-1"},ye={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},xe={class:"bg-white rounded-lg w-full max-w-2xl"},ke={class:"p-4 border-b flex justify-between items-center"},we={class:"text-lg font-semibold"},he={class:"p-4"},Re={class:"mb-4"},Ce={class:"flex justify-center gap-2"},Ae={__name:"ActionPlanButton",props:{taskId:{type:[Number,String],required:!0},user:{type:Object,required:!0}},emits:["action-plan-created"],setup(V,{emit:z}){const x=V,N=z,_=i(!1),F=i(!1),k=i(""),c=i([]),w=i(!1),h=i("image"),d=i(!1),m=i(null),j=i([]),M=i("environment"),u=i(null),b=i(null);let g=null;const O=X(()=>x.user.division_id===20&&x.user.status==="A"||x.user.id_role==="5af56935b011a"&&x.user.status==="A");function I(){_.value=!0}function A(){_.value=!1,k.value="",c.value=[]}function E(a){h.value=a,F.value=!0,U()}function B(){F.value=!1,D()}function q(){M.value=M.value==="environment"?"user":"environment",D(),U()}async function U(){try{g=await navigator.mediaDevices.getUserMedia({video:{facingMode:M.value},audio:h.value==="video"}),u.value&&(u.value.srcObject=g)}catch(a){console.error("Error accessing camera:",a),C.fire({title:"Error",text:"Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera.",icon:"error"})}}function D(){g&&(g.getTracks().forEach(a=>a.stop()),g=null),u.value&&(u.value.srcObject=null),d.value&&S()}function G(){if(!u.value||!b.value)return;const a=b.value.getContext("2d");b.value.width=u.value.videoWidth,b.value.height=u.value.videoHeight,a.drawImage(u.value,0,0);const e=b.value.toDataURL("image/jpeg",.8),o=new Date().getTime();c.value.push({type:"image",url:e,file:W(e,`image_${o}`)}),B()}function H(){d.value?S():J()}function J(){j.value=[],m.value=new MediaRecorder(g,{mimeType:"video/webm;codecs=vp8,opus"}),m.value.ondataavailable=a=>{a.data.size>0&&j.value.push(a.data)},m.value.onstop=async()=>{const a=new Blob(j.value,{type:"video/webm"}),e=URL.createObjectURL(a),r=`video_${new Date().getTime()}.webm`;c.value.push({type:"video",url:e,file:new File([a],r,{type:"video/webm"})}),B()},m.value.start(),d.value=!0}function S(){m.value&&d.value&&(m.value.stop(),d.value=!1)}function K(a){c.value.splice(a,1)}function W(a,e){const o=a.split(","),r=o[0].match(/:(.*?);/)[1],y=atob(o[1]);let s=y.length;const v=new Uint8Array(s);for(;s--;)v[s]=y.charCodeAt(s);const p=r.split("/")[1],T=`${e}.${p}`;return new File([v],T,{type:r})}async function Q(){var a,e,o,r,y;if(!k.value.trim()){C.fire({title:"Perhatian",text:"Deskripsi FRR tidak boleh kosong",icon:"warning"});return}w.value=!0;try{const s=new FormData;s.append("task_id",x.taskId),s.append("description",k.value),console.log("Media files to upload:",c.value),c.value.forEach(p=>{s.append("media[]",p.file,p.file.name)});for(let[p,T]of s.entries())console.log(`${p}:`,T);(await oe.post("/api/action-plans",s,{headers:{"Content-Type":"multipart/form-data",Accept:"application/json"}})).data.success&&(C.fire({title:"Berhasil",text:"FRR berhasil disimpan",icon:"success"}),N("action-plan-created"),A())}catch(s){console.error("Error saving action plan:",s),console.log("Error response:",(a=s.response)==null?void 0:a.data);let v="Gagal menyimpan FRR";(o=(e=s.response)==null?void 0:e.data)!=null&&o.errors?v=Object.values(s.response.data.errors).flat().join(`
`):(y=(r=s.response)==null?void 0:r.data)!=null&&y.message&&(v=s.response.data.message),C.fire({title:"Error",text:v,icon:"error"})}finally{w.value=!1}}return Y(()=>{D()}),(a,e)=>(l(),n("div",null,[O.value?(l(),n("button",{key:0,onClick:I,class:"w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center"},e[3]||(e[3]=[t("i",{class:"fas fa-clipboard-list mr-2"},null,-1),f(" FRR ")]))):R("",!0),(l(),$(P,{to:"body"},[_.value?(l(),n("div",le,[t("div",ie,[t("div",{class:"p-4 border-b flex justify-between items-center"},[e[5]||(e[5]=t("h3",{class:"text-lg font-semibold"},"Buat FRR",-1)),t("button",{onClick:A,class:"text-gray-500 hover:text-gray-700"},e[4]||(e[4]=[t("i",{class:"fas fa-times"},null,-1)]))]),t("div",ne,[t("div",re,[e[6]||(e[6]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Deskripsi FRR",-1)),Z(t("textarea",{"onUpdate:modelValue":e[0]||(e[0]=o=>k.value=o),class:"w-full border rounded p-2",rows:"4",placeholder:"Masukkan deskripsi FRR..."},null,512),[[ee,k.value]])]),t("div",ue,[e[10]||(e[10]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Media",-1)),t("div",ce,[t("button",{onClick:e[1]||(e[1]=o=>E("image")),class:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"},e[7]||(e[7]=[t("i",{class:"fas fa-camera mr-1"},null,-1),f(" Ambil Foto ")])),t("button",{onClick:e[2]||(e[2]=o=>E("video")),class:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"},e[8]||(e[8]=[t("i",{class:"fas fa-video mr-1"},null,-1),f(" Rekam Video ")]))]),t("div",de,[(l(!0),n(te,null,ae(c.value,(o,r)=>(l(),n("div",{key:r,class:"relative group aspect-[4/3]"},[o.type==="image"?(l(),n("img",{key:0,src:o.url,class:"w-full h-full object-contain bg-gray-100 rounded"},null,8,ve)):(l(),n("video",{key:1,src:o.url,class:"w-full h-full object-contain bg-gray-100 rounded",controls:""},null,8,pe)),t("button",{onClick:y=>K(r),class:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"},e[9]||(e[9]=[t("i",{class:"fas fa-trash"},null,-1)]),8,fe)]))),128))])])]),t("div",me,[t("button",{onClick:A,class:"px-4 py-2 border rounded hover:bg-gray-100"}," Batal "),t("button",{onClick:Q,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",disabled:w.value},[w.value?(l(),n("i",ge)):R("",!0),e[11]||(e[11]=f(" Simpan "))],8,be)])])])):R("",!0)])),(l(),$(P,{to:"body"},[F.value?(l(),n("div",ye,[t("div",xe,[t("div",ke,[t("h3",we,L(h.value==="image"?"Ambil Foto":"Rekam Video"),1),t("button",{onClick:B,class:"text-gray-500 hover:text-gray-700"},e[12]||(e[12]=[t("i",{class:"fas fa-times"},null,-1)]))]),t("div",he,[t("div",{class:"flex justify-center gap-2 mb-2"},[t("button",{onClick:q,class:"px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-500"},e[13]||(e[13]=[t("i",{class:"fas fa-sync-alt mr-1"},null,-1),f(" Switch Kamera ")]))]),t("div",Re,[t("video",{ref_key:"videoPreview",ref:u,class:"w-full rounded",autoplay:"",playsinline:""},null,512),t("canvas",{ref_key:"canvas",ref:b,class:"hidden"},null,512)]),t("div",Ce,[h.value==="image"?(l(),n("button",{key:0,onClick:G,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"},e[14]||(e[14]=[t("i",{class:"fas fa-camera mr-1"},null,-1),f(" Ambil Foto ")]))):(l(),n("button",{key:1,onClick:H,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"},[t("i",{class:se(["fas",d.value?"fa-stop":"fa-video"])},null,2),f(" "+L(d.value?"Stop":"Mulai")+" Rekam ",1)]))])])])])):R("",!0)]))]))}};export{Ae as default};
