import{P as st,r as x,c as I,w as D,a as ot,n as lt,L as d,B as u,D as a,E as c,G as f,N as _,H as b,I as G,Q as m,F as T,M as P,J as k,O as nt,x as dt,C,l as S}from"./vendor-vue-g7iCcTkf.js";import{a as j}from"./vendor-utils-CpgP2uT4.js";import{s as ut}from"./vue-multiselect.esm-V-bx43V9.js";/* empty css                            */import{S as h}from"./app-DIuSMidk.js";import{_ as rt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./vendor-charts-CuqD4wLC.js";const mt={class:"flex justify-between items-center mb-4"},_t={key:0,class:"text-xs text-gray-500"},ct={class:"bg-gray-50 rounded-lg p-4 space-y-4"},ft={key:0},bt=["value"],ht=["value"],pt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},yt=["disabled"],gt=["disabled"],vt={class:"space-y-4"},wt={class:"flex justify-between items-center"},xt=["disabled"],kt={key:0,class:"text-center py-8 text-gray-400 border-2 border-dashed rounded-lg"},Bt={class:"flex justify-between items-start"},qt={class:"flex-1"},Dt={class:"font-medium text-gray-800 mb-2"},Tt=["onClick","disabled"],Pt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},jt={class:"md:col-span-2"},It={class:"flex items-center justify-between"},Ct={class:"font-medium text-gray-900"},St={class:"text-sm text-gray-500"},Mt={key:0},Ot={key:1},Vt={key:2},Ut=["onUpdate:modelValue","onInput","disabled"],At={class:"flex gap-2"},Nt={class:"flex-1"},Et=["onUpdate:modelValue","disabled"],Ft={class:"flex-1"},Kt=["value","disabled"],Wt={key:0,class:"mt-4"},Gt=["onClick"],Lt={class:"flex items-center gap-2"},Qt={key:0,class:"text-sm text-gray-500"},$t={key:0,class:"mt-3 bg-gray-50 rounded-lg p-4"},Rt={class:"overflow-x-auto"},Ht={class:"w-full text-sm"},Jt={class:"py-2 px-2"},zt={class:"py-2 px-2"},Xt={class:"py-2 px-2"},Yt={class:"py-2 px-2"},Zt={key:1,class:"mt-3 bg-yellow-50 border border-yellow-200 rounded-lg p-4"},te={class:"flex justify-end gap-3 pt-6 border-t"},ee=["disabled"],ie={key:0,class:"loading loading-spinner loading-sm"},ae=["disabled"],se={key:0,class:"loading loading-spinner loading-sm"},oe={__name:"Form",props:{items:Array,warehouse_outlets:Array,outlets:Array,user_outlet_id:Number,headerData:Object,detailData:Array},emits:["submitted","cancel"],setup(B,{emit:L}){var A,N,E,F,K,W;const n=B,Q=L,i=st({header_id:((A=n.headerData)==null?void 0:A.id)||null,outlet_id:n.user_outlet_id!==1?n.user_outlet_id:((N=n.headerData)==null?void 0:N.outlet_id)||"",warehouse_outlet_id:((E=n.headerData)==null?void 0:E.warehouse_outlet_id)||"",production_date:((F=n.headerData)==null?void 0:F.production_date)||new Date().toISOString().split("T")[0],batch_number:((K=n.headerData)==null?void 0:K.batch_number)||"",notes:((W=n.headerData)==null?void 0:W.notes)||"",productions:n.detailData&&n.detailData.length>0?n.detailData.map(s=>{const t=n.items.find(o=>o.id==s.item_id)||null,e=(t==null?void 0:t.small_unit_id)||s.unit_id;return{id:s.id||null,item_id:s.item_id,selectedItem:t,itemData:t,qty:s.qty,qty_jadi:s.qty_jadi,unit_id:e,bom:[],showBom:!1,loadingBom:!1,canProduce:!1}}):[]}),v=x(!1),p=x(!1),q=x(null),y=x(null),g=x(!1),M=I(()=>n.user_outlet_id!==1?n.warehouse_outlets.filter(s=>s.outlet_id==n.user_outlet_id):i.outlet_id?n.warehouse_outlets.filter(s=>s.outlet_id==i.outlet_id):n.warehouse_outlets),O=I(()=>i.outlet_id&&i.warehouse_outlet_id&&i.production_date&&i.productions.length>0&&i.productions.every(s=>s.item_id&&s.qty>0&&s.qty_jadi>=0&&s.unit_id)),V=I(()=>O.value&&i.productions.every(s=>!s.bom||s.bom.length===0?!1:s.canProduce&&s.bom.every(t=>t.sufficient)));function $(){return{id:null,item_id:"",selectedItem:null,itemData:null,qty:1,qty_jadi:0,unit_id:"",bom:[],showBom:!1,loadingBom:!1,canProduce:!1}}function R(){i.productions.push($())}function H(s){i.productions.length>1&&i.productions.splice(s,1)}function J(){i.warehouse_outlet_id="",i.productions.forEach(s=>{s.item_id="",s.selectedItem=null,s.itemData=null,s.unit_id="",s.bom=[],s.showBom=!1})}function z(){i.productions.forEach(s=>{s.item_id="",s.selectedItem=null,s.itemData=null,s.unit_id="",s.bom=[],s.showBom=!1})}function X(s,t){var o;const e=i.productions[t];e.item_id=s.id,e.selectedItem=s,e.itemData=n.items.find(r=>r.id==s.id)||null,(o=e.itemData)!=null&&o.small_unit_id?e.unit_id=e.itemData.small_unit_id:e.unit_id="",e.bom=[],e.showBom=!1,e.canProduce=!1,e.item_id&&e.qty>0&&i.outlet_id&&i.warehouse_outlet_id&&w(t)}function Y(s){const t=i.productions[s];t.item_id="",t.selectedItem=null,t.itemData=null,t.unit_id="",t.bom=[],t.showBom=!1,t.canProduce=!1}function Z(s){const t=i.productions[s];t.item_id&&t.qty>0&&i.outlet_id&&i.warehouse_outlet_id?w(s):(t.bom=[],t.canProduce=!1)}async function w(s){var e;const t=i.productions[s];if(!t.item_id||!t.qty||!i.outlet_id||!i.warehouse_outlet_id){t.bom=[],t.canProduce=!1;return}t.loadingBom=!0;try{const o=await j.post("/outlet-wip/bom",{item_id:t.item_id,qty:t.qty,outlet_id:i.outlet_id,warehouse_outlet_id:i.warehouse_outlet_id});if(t.bom=o.data||[],t.canProduce=t.bom.length>0&&t.bom.every(r=>r.sufficient),t.bom.length===0){const r=((e=t.selectedItem)==null?void 0:e.name)||"Item yang dipilih";await h.fire({icon:"warning",title:"Item Tidak Memiliki BOM",html:`
          <div class="text-left">
            <p class="mb-3"><strong>${r}</strong> tidak memiliki Bill of Materials (BOM).</p>
            <p class="text-sm text-gray-600 mb-3">Untuk melakukan produksi, item harus memiliki komposisi bahan yang telah didefinisikan.</p>
          </div>
        `,confirmButtonText:"OK",confirmButtonColor:"#3b82f6"})}}catch(o){console.error("Error fetching BOM:",o),t.bom=[],t.canProduce=!1,await h.fire({icon:"error",title:"Error",text:"Terjadi kesalahan saat mengambil data BOM. Silakan coba lagi.",confirmButtonText:"OK",confirmButtonColor:"#ef4444"})}finally{t.loadingBom=!1}}function U(s){return s==null?"0.00":new Intl.NumberFormat("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}).format(s)}function tt(s){return s?new Date(s).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}):"-"}async function et(){if(g.value||!i.outlet_id||!i.warehouse_outlet_id||!i.production_date||i.productions.length===0)return;const s=i.productions.filter(t=>t.item_id&&t.qty>0&&t.qty_jadi>=0&&t.unit_id);if(s.length!==0){g.value=!0;try{const t={outlet_id:i.outlet_id,warehouse_outlet_id:i.warehouse_outlet_id,production_date:i.production_date,batch_number:i.batch_number,notes:i.notes,productions:s.map(o=>({item_id:o.item_id,qty:o.qty,qty_jadi:o.qty_jadi,unit_id:o.unit_id})),autosave:!0},e=await j.post(route("outlet-wip.store"),t,{headers:{Accept:"application/json","Content-Type":"application/json"}});e.data.success&&e.data.header_id&&(i.header_id=e.data.header_id,q.value=new Date,console.log("✅ Autosave: Draft saved with header_id:",e.data.header_id))}catch(t){console.error("❌ Autosave failed:",t)}finally{g.value=!1}}}D(()=>[i.outlet_id,i.warehouse_outlet_id,i.production_date,i.batch_number,i.notes,i.productions],()=>{g.value||(y.value&&clearTimeout(y.value),y.value=setTimeout(()=>{g.value||et()},3e3))},{deep:!0});async function it(){var s,t;if(!p.value){for(p.value=!0,y.value&&(clearTimeout(y.value),y.value=null);g.value;)await new Promise(e=>setTimeout(e,100));try{const e={outlet_id:i.outlet_id,warehouse_outlet_id:i.warehouse_outlet_id,production_date:i.production_date,batch_number:i.batch_number,notes:i.notes,productions:i.productions.filter(r=>r.item_id&&r.qty>0&&r.qty_jadi>=0&&r.unit_id).map(r=>({item_id:r.item_id,qty:r.qty,qty_jadi:r.qty_jadi,unit_id:r.unit_id})),autosave:!1},o=await j.post(route("outlet-wip.store"),e,{headers:{Accept:"application/json","Content-Type":"application/json"}});o.data.success&&(o.data.header_id&&(i.header_id=o.data.header_id),q.value=new Date,h.fire({icon:"success",title:"Berhasil",text:"Draft berhasil disimpan",timer:1500,showConfirmButton:!1}))}catch(e){console.error("Save draft failed:",e),h.fire({icon:"error",title:"Gagal",text:((t=(s=e.response)==null?void 0:s.data)==null?void 0:t.message)||"Gagal menyimpan draft",confirmButtonText:"OK"})}finally{p.value=!1}}}function at(){if(!V.value){h.fire({icon:"warning",title:"Validasi Gagal",text:"Pastikan semua item memiliki BOM yang valid dan stock cukup",confirmButtonText:"OK"});return}v.value=!0;const s={outlet_id:i.outlet_id,warehouse_outlet_id:i.warehouse_outlet_id,production_date:i.production_date,batch_number:i.batch_number,notes:i.notes,productions:i.productions.filter(e=>e.item_id&&e.qty>0&&e.qty_jadi>=0&&e.unit_id).map(e=>({item_id:e.item_id,qty:e.qty,qty_jadi:e.qty_jadi,unit_id:e.unit_id}))},t=i.header_id?route("outlet-wip.submit",i.header_id):route("outlet-wip.store-and-submit");j.post(t,s,{headers:{Accept:"application/json","Content-Type":"application/json"}}).then(e=>{e.data.success&&h.fire({icon:"success",title:"Berhasil",text:e.data.message||"Produksi WIP berhasil disubmit",timer:1500,showConfirmButton:!1}).then(()=>{Q("submitted")})}).catch(e=>{var o,r;console.error("Submit failed:",e),h.fire({icon:"error",title:"Gagal Submit",text:((r=(o=e.response)==null?void 0:o.data)==null?void 0:r.message)||"Gagal submit produksi",confirmButtonText:"OK"})}).finally(()=>{v.value=!1})}return D(()=>i.outlet_id,s=>{s&&i.warehouse_outlet_id&&(M.value.find(e=>e.id==i.warehouse_outlet_id)||(i.warehouse_outlet_id=""))}),ot(async()=>{n.headerData&&n.detailData&&n.detailData.length>0&&(await lt(),setTimeout(()=>{i.productions.forEach((s,t)=>{s.item_id&&s.qty>0&&i.outlet_id&&i.warehouse_outlet_id?(console.log("Auto-fetching BoM for production",t,s.item_id,{item_id:s.item_id,qty:s.qty,outlet_id:i.outlet_id,warehouse_outlet_id:i.warehouse_outlet_id}),w(t)):console.log("Skipping BoM fetch for production",t,{item_id:s.item_id,qty:s.qty,outlet_id:i.outlet_id,warehouse_outlet_id:i.warehouse_outlet_id})})},800))}),D(()=>i.warehouse_outlet_id,(s,t)=>{s&&!t&&n.headerData&&i.productions.length>0&&setTimeout(()=>{i.productions.forEach((e,o)=>{e.item_id&&e.qty>0&&i.outlet_id&&i.warehouse_outlet_id&&(console.log("Auto-fetching BoM after warehouse change",o,e.item_id),w(o))})},300)}),D(()=>i.productions,s=>{n.headerData&&s&&s.length>0&&i.outlet_id&&i.warehouse_outlet_id&&setTimeout(()=>{s.forEach((t,e)=>{t.item_id&&t.qty>0&&(!t.bom||t.bom.length===0)&&(console.log("Auto-fetching BoM for loaded production",e,t.item_id),w(e))})},500)},{deep:!1,immediate:!1}),(s,t)=>(u(),d("div",null,[a("div",mt,[t[7]||(t[7]=a("h2",{class:"text-lg font-bold flex items-center gap-2"},[a("i",{class:"fa-solid fa-industry text-blue-500"}),f(" Buat Produksi WIP Baru ")],-1)),q.value?(u(),d("div",_t,[t[6]||(t[6]=a("i",{class:"fa fa-check-circle text-green-500 mr-1"},null,-1)),f(" Terakhir disimpan: "+_(tt(q.value)),1)])):c("",!0)]),a("form",{onSubmit:nt(at,["prevent"]),class:"space-y-4"},[a("div",ct,[t[15]||(t[15]=a("h3",{class:"font-semibold text-gray-700 mb-2"},"Informasi Umum",-1)),B.user_outlet_id==1?(u(),d("div",ft,[t[9]||(t[9]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Outlet",-1)),b(a("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>m(i).outlet_id=e),onChange:J,class:"input input-bordered w-full",required:""},[t[8]||(t[8]=a("option",{value:"",disabled:""},"Pilih Outlet",-1)),(u(!0),d(T,null,P(B.outlets,e=>(u(),d("option",{key:e.id,value:e.id},_(e.name),9,bt))),128))],544),[[G,m(i).outlet_id]])])):c("",!0),a("div",null,[t[11]||(t[11]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Warehouse Outlet",-1)),b(a("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>m(i).warehouse_outlet_id=e),onChange:z,class:"input input-bordered w-full",required:""},[t[10]||(t[10]=a("option",{value:"",disabled:""},"Pilih Warehouse Outlet",-1)),(u(!0),d(T,null,P(M.value,e=>(u(),d("option",{key:e.id,value:e.id},_(e.name),9,ht))),128))],544),[[G,m(i).warehouse_outlet_id]])]),a("div",pt,[a("div",null,[t[12]||(t[12]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Tanggal Produksi",-1)),b(a("input",{type:"date","onUpdate:modelValue":t[2]||(t[2]=e=>m(i).production_date=e),class:"input input-bordered w-full",required:"",disabled:!m(i).warehouse_outlet_id},null,8,yt),[[k,m(i).production_date]])]),a("div",null,[t[13]||(t[13]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Batch Number",-1)),b(a("input",{type:"text","onUpdate:modelValue":t[3]||(t[3]=e=>m(i).batch_number=e),class:"input input-bordered w-full",placeholder:"Batch/No Lot",disabled:!m(i).warehouse_outlet_id},null,8,gt),[[k,m(i).batch_number]])])]),a("div",null,[t[14]||(t[14]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Catatan",-1)),b(a("textarea",{"onUpdate:modelValue":t[4]||(t[4]=e=>m(i).notes=e),class:"input input-bordered w-full",rows:"2",placeholder:"Catatan produksi (opsional)"},null,512),[[k,m(i).notes]])])]),a("div",vt,[a("div",wt,[t[17]||(t[17]=a("h3",{class:"font-semibold text-gray-700"},"Item Produksi",-1)),a("button",{type:"button",onClick:R,class:"btn btn-sm btn-primary",disabled:!m(i).warehouse_outlet_id},t[16]||(t[16]=[a("i",{class:"fa fa-plus mr-1"},null,-1),f(" Tambah Item ")]),8,xt)]),m(i).productions.length===0?(u(),d("div",kt,t[18]||(t[18]=[a("i",{class:"fa fa-box-open text-4xl mb-2"},null,-1),a("p",null,'Belum ada item produksi. Klik "Tambah Item" untuk menambahkan.',-1)]))):c("",!0),(u(!0),d(T,null,P(m(i).productions,(e,o)=>{var r;return u(),d("div",{key:e.id,class:"bg-white border rounded-lg p-4 space-y-4"},[a("div",Bt,[a("div",qt,[a("h4",Dt,"Item Produksi #"+_(o+1),1)]),a("button",{type:"button",onClick:l=>H(o),class:"btn btn-sm btn-error text-white",disabled:m(i).productions.length===1},t[19]||(t[19]=[a("i",{class:"fa fa-trash"},null,-1)]),8,Tt)]),a("div",Pt,[a("div",jt,[t[22]||(t[22]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Item Hasil Produksi",-1)),dt(m(ut),{modelValue:e.selectedItem,"onUpdate:modelValue":l=>e.selectedItem=l,options:B.items,searchable:!0,"close-on-select":!0,"show-labels":!1,placeholder:"Cari dan pilih item...",label:"name","track-by":"id",disabled:!m(i).warehouse_outlet_id,onSelect:l=>X(l,o),onRemove:()=>Y(o),class:"multiselect-custom"},{option:C(({option:l})=>[a("div",It,[a("div",null,[a("div",Ct,_(l.name),1),a("div",St,[l.small_unit_name?(u(),d("span",Mt,"Small: "+_(l.small_unit_name),1)):c("",!0),l.medium_unit_name?(u(),d("span",Ot," | Medium: "+_(l.medium_unit_name),1)):c("",!0),l.large_unit_name?(u(),d("span",Vt," | Large: "+_(l.large_unit_name),1)):c("",!0)])])])]),noResult:C(()=>t[20]||(t[20]=[a("div",{class:"text-center py-2 text-gray-500"},[a("i",{class:"fa-solid fa-search mr-2"}),f(" Tidak ada item yang ditemukan ")],-1)])),noOptions:C(()=>t[21]||(t[21]=[a("div",{class:"text-center py-2 text-gray-500"},[a("i",{class:"fa-solid fa-box mr-2"}),f(" Tidak ada item tersedia ")],-1)])),_:2},1032,["modelValue","onUpdate:modelValue","options","disabled","onSelect","onRemove"])]),a("div",null,[t[23]||(t[23]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Qty Produksi",-1)),b(a("input",{type:"number",min:"0",step:"0.01","onUpdate:modelValue":l=>e.qty=l,class:"input input-bordered w-full",required:"",onInput:()=>Z(o),disabled:!m(i).warehouse_outlet_id||!e.item_id},null,40,Ut),[[k,e.qty,void 0,{number:!0}]])]),a("div",At,[a("div",Nt,[t[24]||(t[24]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Qty Jadi",-1)),b(a("input",{type:"number",min:"0",step:"0.01","onUpdate:modelValue":l=>e.qty_jadi=l,class:"input input-bordered w-full",required:"",disabled:!m(i).warehouse_outlet_id||!e.item_id},null,8,Et),[[k,e.qty_jadi,void 0,{number:!0}]])]),a("div",Ft,[t[25]||(t[25]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Unit",-1)),a("input",{type:"text",value:((r=e.itemData)==null?void 0:r.small_unit_name)||"-",class:"input input-bordered w-full bg-gray-50",readonly:"",disabled:!e.item_id},null,8,Kt)])])]),e.item_id&&e.qty>0?(u(),d("div",Wt,[a("button",{type:"button",onClick:l=>e.showBom=!e.showBom,class:"w-full flex items-center justify-between p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors"},[a("div",Lt,[a("i",{class:S(["fa fa-chevron-down transition-transform",e.showBom?"rotate-180":""])},null,2),t[26]||(t[26]=a("span",{class:"font-medium text-gray-700"},"Lihat BoM & Stock",-1)),e.bom&&e.bom.length>0?(u(),d("span",{key:0,class:S(["px-2 py-1 rounded text-xs font-semibold",e.canProduce?"bg-green-100 text-green-700":"bg-red-100 text-red-700"])},_(e.canProduce?"✓ Bisa Diproduksi":"✗ Tidak Bisa Diproduksi"),3)):c("",!0)]),e.loadingBom?(u(),d("span",Qt,t[27]||(t[27]=[a("i",{class:"fa fa-spinner fa-spin"},null,-1),f(" Memuat... ")]))):c("",!0)],8,Gt),e.showBom&&e.bom&&e.bom.length>0?(u(),d("div",$t,[t[29]||(t[29]=a("h4",{class:"font-semibold text-gray-700 mb-3"},"Bill of Materials (BOM)",-1)),a("div",Rt,[a("table",Ht,[t[28]||(t[28]=a("thead",null,[a("tr",{class:"border-b"},[a("th",{class:"text-left py-2 px-2"},"Material"),a("th",{class:"text-left py-2 px-2"},"Qty Dibutuhkan"),a("th",{class:"text-left py-2 px-2"},"Stok Tersedia"),a("th",{class:"text-left py-2 px-2"},"Status")])],-1)),a("tbody",null,[(u(!0),d(T,null,P(e.bom,l=>(u(),d("tr",{key:l.material_item_id,class:"border-b"},[a("td",Jt,_(l.material_name),1),a("td",zt,_(U(l.qty_needed))+" "+_(l.material_unit_name),1),a("td",Xt,_(U(l.stock))+" "+_(l.material_unit_name),1),a("td",Yt,[a("span",{class:S([l.sufficient?"text-green-600":"text-red-600","font-semibold"])},_(l.sufficient?"✓ Cukup":"✗ Kurang"),3)])]))),128))])])])])):e.showBom&&e.bom&&e.bom.length===0?(u(),d("div",Zt,t[30]||(t[30]=[a("div",{class:"flex items-center gap-2 text-yellow-800"},[a("i",{class:"fa fa-exclamation-triangle"}),a("span",{class:"font-medium"},"Item ini tidak memiliki BOM")],-1),a("p",{class:"text-sm text-yellow-700 mt-2"}," Untuk melakukan produksi, item harus memiliki komposisi bahan yang telah didefinisikan. ",-1)]))):c("",!0)])):c("",!0)])}),128))]),a("div",te,[a("button",{type:"button",onClick:it,disabled:p.value||!O.value,class:"btn btn-outline"},[p.value?(u(),d("span",ie)):c("",!0),f(" "+_(p.value?"Menyimpan...":"Simpan Draft"),1)],8,ee),a("button",{type:"button",onClick:t[5]||(t[5]=e=>s.$emit("cancel")),class:"btn btn-outline"}," Batal "),a("button",{type:"submit",disabled:v.value||!V.value,class:"btn btn-primary"},[v.value?(u(),d("span",se)):c("",!0),f(" "+_(v.value?"Menyimpan...":"Submit Produksi"),1)],8,ae)])],32)]))}},ce=rt(oe,[["__scopeId","data-v-9fca8253"]]);export{ce as default};
