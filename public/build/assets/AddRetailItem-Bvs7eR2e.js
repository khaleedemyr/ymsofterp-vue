import{r,c as ee,b as te,L as u,B as d,D as e,x as v,H as x,J as h,G as p,F as T,M as j,N,E as $,O as ae,C as _,Q as g}from"./vendor-vue-g7iCcTkf.js";import{a as se}from"./vendor-utils-CpgP2uT4.js";import{S as M}from"./app-3SxMownK.js";import{Y as le,h as G,_ as oe,G as ne,S as re}from"./vendor-ui-CrPgGUUb.js";import"./vendor-charts-CuqD4wLC.js";const ie={class:"add-retail-item"},ue={class:"bg-gray-50 p-4 rounded-lg"},de={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},me={class:"mt-4"},ce={class:"flex flex-wrap gap-2 mb-2"},be={class:"flex flex-wrap gap-2"},fe=["src"],ve=["onClick"],pe={class:"bg-gray-50 p-4 rounded-lg"},ge={class:"space-y-4"},ye={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},xe=["onUpdate:modelValue"],he=["onUpdate:modelValue","onInput"],_e=["onUpdate:modelValue","onInput"],we={class:"relative"},ke=["value"],Ce=["onClick"],Ie={class:"flex flex-wrap gap-2 mb-2"},De=["onClick"],Fe={class:"flex flex-wrap gap-2"},Be=["src"],Ue=["onClick"],Se={class:"flex justify-between items-center mt-4"},Te={class:"text-right"},je={class:"ml-2 text-lg font-semibold"},qe={class:"flex justify-end mt-4"},Ve=["disabled"],Ee={key:0,class:"fas fa-spinner fa-spin mr-2"},Ae={class:"fixed inset-0 overflow-y-auto"},Ne={class:"flex min-h-full items-center justify-center p-4"},$e={class:"p-4 border-b flex justify-between items-center"},Me={class:"text-lg font-semibold"},Ge={class:"p-4"},Le={class:"mb-4"},Je={__name:"AddRetailItem",props:{taskId:{type:[Number,String],required:!0}},emits:["saved"],setup(L,{emit:O}){const R=L,H=O,w=r(!1),m=r({nama_toko:"",alamat_toko:""}),n=r([B()]),y=r([]),C=r(!1),I=r("invoice"),D=r(null),i=r(null),b=r(null),F=r("environment");let f=null;function B(){return{nama_barang:"",qty:1,harga_barang:"",subtotal:0,barang_images:[]}}function q(a){const t=n.value[a];t.subtotal=(parseFloat(t.qty)||0)*(parseFloat(t.harga_barang)||0)}const P=ee(()=>n.value.reduce((a,t)=>a+(t.subtotal||0),0));function V(a){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(a)}function z(){n.value.push(B())}function J(a){n.value.splice(a,1)}function Q(a){y.value.splice(a,1)}function Y(a,t){n.value[a].barang_images.splice(t,1)}function E(a,t=null){I.value=a,D.value=t,C.value=!0,A()}function k(){C.value=!1,U()}async function A(){try{f&&U(),f=await navigator.mediaDevices.getUserMedia({video:{facingMode:F.value}}),i.value&&(i.value.srcObject=f)}catch(a){console.error("Error accessing camera:",a),alert("Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera.")}}async function W(){F.value=F.value==="environment"?"user":"environment",await A()}function U(){f&&(f.getTracks().forEach(a=>a.stop()),f=null),i.value&&(i.value.srcObject=null)}function K(){if(!i.value||!b.value)return;const a=b.value.getContext("2d");b.value.width=i.value.videoWidth,b.value.height=i.value.videoHeight,a.drawImage(i.value,0,0);const t=b.value.toDataURL("image/jpeg",.8),s=new Date().getTime(),l={url:t,file:X(t,`image_${s}.jpg`)};I.value==="invoice"?y.value.push(l):D.value!==null&&n.value[D.value].barang_images.push(l),k()}function X(a,t){const s=a.split(","),l=s[0].match(/:(.*?);/)[1],o=atob(s[1]);let c=o.length;const S=new Uint8Array(c);for(;c--;)S[c]=o.charCodeAt(c);return new File([S],t,{type:l})}async function Z(){w.value=!0;try{const a=new FormData;a.append("task_id",R.taskId),a.append("nama_toko",m.value.nama_toko),a.append("alamat_toko",m.value.alamat_toko),console.log("Items to send:",n.value),a.append("items",JSON.stringify(n.value.map(s=>({nama_barang:s.nama_barang,qty:s.qty,harga_barang:s.harga_barang,subtotal:s.subtotal}))));for(let[s,l]of a.entries())console.log(`${s}:`,l);y.value.forEach(s=>{a.append("invoice_files[]",s.file)}),n.value.forEach((s,l)=>{s.barang_images.forEach(o=>{a.append(`barang_files[${l}][]`,o.file)})}),(await se.post("/api/retail",a,{headers:{"Content-Type":"multipart/form-data"}})).data.success&&(M.fire({icon:"success",title:"Berhasil!",text:"Data retail berhasil disimpan",timer:1500,showConfirmButton:!1}),H("saved"),m.value={nama_toko:"",alamat_toko:""},n.value=[B()],y.value=[])}catch(a){console.error("Error saving retail items:",a),a.response&&console.error("Error response:",a.response.data),M.fire({icon:"error",title:"Error!",text:"Gagal menyimpan data retail. Silakan coba lagi."})}finally{w.value=!1}}return te(()=>{U()}),(a,t)=>(d(),u("div",ie,[e("form",{onSubmit:ae(Z,["prevent"]),class:"space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto pr-2"},[e("div",ue,[t[8]||(t[8]=e("h3",{class:"font-medium mb-3"},"Detail Toko",-1)),e("div",de,[e("div",null,[t[3]||(t[3]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Nama Toko ",-1)),x(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>m.value.nama_toko=s),type:"text",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",required:""},null,512),[[h,m.value.nama_toko]])]),e("div",null,[t[4]||(t[4]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Alamat Toko ",-1)),x(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>m.value.alamat_toko=s),type:"text",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",required:""},null,512),[[h,m.value.alamat_toko]])])]),e("div",me,[t[7]||(t[7]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Invoice Images ",-1)),e("div",ce,[e("button",{type:"button",onClick:t[2]||(t[2]=s=>E("invoice")),class:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"},t[5]||(t[5]=[e("i",{class:"fas fa-camera mr-1"},null,-1),p(" Ambil Foto Invoice ")]))]),e("div",be,[(d(!0),u(T,null,j(y.value,(s,l)=>(d(),u("div",{key:l,class:"relative w-24 h-24 border rounded-lg overflow-hidden"},[e("img",{src:s.url,class:"w-full h-full object-cover"},null,8,fe),e("button",{type:"button",onClick:o=>Q(l),class:"absolute top-0 right-0 bg-red-500 text-white p-1 rounded-full"},t[6]||(t[6]=[e("i",{class:"fas fa-times"},null,-1)]),8,ve)]))),128))])])]),e("div",pe,[t[19]||(t[19]=e("div",{class:"flex justify-between items-center mb-3"},[e("h3",{class:"font-medium"},"Daftar Barang")],-1)),e("div",ge,[(d(!0),u(T,null,j(n.value,(s,l)=>(d(),u("div",{key:l,class:"grid grid-cols-1 gap-4 pb-4 border-b border-gray-200 last:border-0"},[e("div",ye,[e("div",null,[t[9]||(t[9]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Nama Barang ",-1)),x(e("input",{"onUpdate:modelValue":o=>s.nama_barang=o,type:"text",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",required:""},null,8,xe),[[h,s.nama_barang]])]),e("div",null,[t[10]||(t[10]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Qty ",-1)),x(e("input",{"onUpdate:modelValue":o=>s.qty=o,type:"number",min:"1",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",onInput:o=>q(l),required:""},null,40,he),[[h,s.qty]])]),e("div",null,[t[11]||(t[11]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Harga Barang ",-1)),x(e("input",{"onUpdate:modelValue":o=>s.harga_barang=o,type:"number",min:"0",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",onInput:o=>q(l),required:""},null,40,_e),[[h,s.harga_barang]])]),e("div",we,[t[13]||(t[13]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Subtotal ",-1)),e("input",{value:V(s.subtotal),type:"text",class:"w-full rounded-md border-gray-300 bg-gray-50 shadow-sm",readonly:""},null,8,ke),n.value.length>1?(d(),u("button",{key:0,type:"button",onClick:o=>J(l),class:"absolute top-0 -right-8 text-red-500 hover:text-red-700 p-2"},t[12]||(t[12]=[e("i",{class:"fas fa-trash"},null,-1)]),8,Ce)):$("",!0)])]),e("div",null,[t[16]||(t[16]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," Barang Images ",-1)),e("div",Ie,[e("button",{type:"button",onClick:o=>E("barang",l),class:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"},t[14]||(t[14]=[e("i",{class:"fas fa-camera mr-1"},null,-1),p(" Ambil Foto Barang ")]),8,De)]),e("div",Fe,[(d(!0),u(T,null,j(s.barang_images,(o,c)=>(d(),u("div",{key:c,class:"relative w-24 h-24 border rounded-lg overflow-hidden"},[e("img",{src:o.url,class:"w-full h-full object-cover"},null,8,Be),e("button",{type:"button",onClick:S=>Y(l,c),class:"absolute top-0 right-0 bg-red-500 text-white p-1 rounded-full"},t[15]||(t[15]=[e("i",{class:"fas fa-times"},null,-1)]),8,Ue)]))),128))])])]))),128))]),e("div",Se,[e("button",{type:"button",onClick:z,class:"text-blue-500 hover:text-blue-700"},t[17]||(t[17]=[e("i",{class:"fas fa-plus mr-1"},null,-1),p(" Tambah Item ")])),e("div",Te,[t[18]||(t[18]=e("span",{class:"text-sm font-medium text-gray-700"},"Grand Total:",-1)),e("span",je,N(V(P.value)),1)])])]),e("div",qe,[e("button",{type:"submit",class:"bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600",disabled:w.value},[w.value?(d(),u("i",Ee)):$("",!0),t[20]||(t[20]=p(" Simpan "))],8,Ve)])],32),v(g(re),{appear:"",show:C.value,as:"template"},{default:_(()=>[v(g(le),{as:"div",onClose:k,class:"relative z-[9999]"},{default:_(()=>[v(g(G),{enter:"duration-300 ease-out","enter-from":"opacity-0","enter-to":"opacity-100",leave:"duration-200 ease-in","leave-from":"opacity-100","leave-to":"opacity-0"},{default:_(()=>[v(g(oe),{class:"fixed inset-0 bg-black/40"})]),_:1}),e("div",Ae,[e("div",Ne,[v(g(G),{enter:"duration-300 ease-out","enter-from":"opacity-0 scale-95","enter-to":"opacity-100 scale-100",leave:"duration-200 ease-in","leave-from":"opacity-100 scale-100","leave-to":"opacity-0 scale-95"},{default:_(()=>[v(g(ne),{class:"w-full max-w-2xl transform overflow-hidden rounded-lg bg-white shadow-xl transition-all"},{default:_(()=>[e("div",$e,[e("h3",Me,N(I.value==="invoice"?"Ambil Foto Invoice":"Ambil Foto Barang"),1),e("div",{class:"flex items-center gap-2"},[e("button",{onClick:W,class:"text-gray-500 hover:text-gray-700 px-2 py-1"},t[21]||(t[21]=[e("i",{class:"fas fa-sync"},null,-1)])),e("button",{onClick:k,class:"text-gray-500 hover:text-gray-700"},t[22]||(t[22]=[e("i",{class:"fas fa-times"},null,-1)]))])]),e("div",Ge,[e("div",Le,[e("video",{ref_key:"videoPreview",ref:i,class:"w-full rounded",autoplay:"",playsinline:""},null,512),e("canvas",{ref_key:"canvas",ref:b,class:"hidden"},null,512)]),e("div",{class:"flex justify-center gap-2"},[e("button",{type:"button",onClick:K,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"},t[23]||(t[23]=[e("i",{class:"fas fa-camera mr-1"},null,-1),p(" Ambil Foto ")])),e("button",{type:"button",onClick:k,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"},t[24]||(t[24]=[e("i",{class:"fas fa-times mr-1"},null,-1),p(" Batal ")]))])])]),_:1})]),_:1})])])]),_:1})]),_:1},8,["show"])]))}};export{Je as default};
