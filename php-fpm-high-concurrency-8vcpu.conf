; ============================================
; PHP-FPM Configuration untuk Ratusan Concurrent Users
; Server: 8 vCPU, 16GB RAM
; Target: 200-500 concurrent users
; ============================================

[www]
user = ymsuperadmin
group = ymsuperadmin
listen = /var/cpanel/php/sockets/ymsuperadmin/php82.sock
listen.owner = ymsuperadmin
listen.group = ymsuperadmin
listen.mode = 0660

; ============================================
; Process Manager Settings
; ============================================
; Dynamic process manager untuk adjust based on load
pm = dynamic

; Max Children: 8 vCPU × 5 = 40
; Untuk handle ratusan concurrent users
; Memory: 40 × 120MB = 4.8GB (masih dalam limit 6-8GB available)
pm.max_children = 40

; Start dengan 50% dari max untuk quick response
pm.start_servers = 20

; Minimum spare servers (30% dari max)
; Untuk handle traffic spike
pm.min_spare_servers = 12

; Maximum spare servers (50% dari max)
; Untuk handle traffic spike
pm.max_spare_servers = 20

; Max requests per process sebelum restart
; 50 cukup untuk prevent memory leak tanpa terlalu sering restart
pm.max_requests = 50

; Process idle timeout
; Kill idle process setelah 10 detik untuk free memory
pm.process_idle_timeout = 10s

; ============================================
; Performance Tuning
; ============================================
; Enable status page untuk monitoring
pm.status_path = /php-fpm-status
ping.path = /php-fpm-ping

; Request timeout
; 180s (3 menit) untuk handle heavy requests
request_terminate_timeout = 180s

; Slow log timeout
; Log request yang lebih dari 10 detik
request_slowlog_timeout = 10s
slowlog = /var/log/php-fpm/www-slow.log

; ============================================
; PHP Settings (Optimized untuk High Traffic)
; ============================================
; Memory limit per process
; 128M cukup untuk Laravel dengan caching
; Jika perlu, bisa naikkan ke 192M, tapi akan reduce max_children
php_admin_value[memory_limit] = 128M

; Max execution time
php_admin_value[max_execution_time] = 180

; Max input time
php_admin_value[max_input_time] = 180

; Upload settings
php_admin_value[upload_max_filesize] = 64M
php_admin_value[post_max_size] = 64M
php_admin_value[max_input_vars] = 5000

; Error reporting (production)
php_admin_flag[display_errors] = off
php_admin_flag[log_errors] = on

; ============================================
; OPcache Settings (CRITICAL untuk Performance)
; ============================================
; OPcache sangat penting untuk high traffic
; Reduce load pada PHP parser
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 512
php_admin_value[opcache.interned_strings_buffer] = 32
php_admin_value[opcache.max_accelerated_files] = 50000
php_admin_value[opcache.revalidate_freq] = 0
php_admin_value[opcache.validate_timestamps] = 0
php_admin_value[opcache.save_comments] = 1
php_admin_value[opcache.fast_shutdown] = 1
php_admin_value[opcache.enable_cli] = 0

; ============================================
; Realpath Cache (CRITICAL untuk Laravel)
; ============================================
; Laravel banyak menggunakan realpath
; Cache ini sangat membantu performance
php_admin_value[realpath_cache_size] = 16M
php_admin_value[realpath_cache_ttl] = 3600

; ============================================
; Logging
; ============================================
; Access log dengan detailed format
access.log = /var/log/php-fpm/www-access.log
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"

; Error log
php_admin_value[error_log] = /var/log/php-fpm/www-error.log
php_admin_flag[log_errors] = on

; ============================================
; Security
; ============================================
; Hanya allow .php extension
security.limit_extensions = .php

; ============================================
; Environment
; ============================================
clear_env = no

; ============================================
; Catch Workers Output
; ============================================
catch_workers_output = yes
decorate_workers_output = no

; ============================================
; CATATAN PENTING:
; ============================================
; 1. Settingan ini untuk handle 200-500 concurrent users
; 2. Pastikan MySQL max_connections minimal 100
; 3. Monitor memory usage (should be < 80%)
; 4. Monitor CPU usage (should be 60-80% during peak)
; 5. Jika masih CPU 100%, cek:
;    - Database slow queries
;    - N+1 query problems
;    - Queue workers yang stuck
;    - Scheduled tasks yang overlap
; 6. Pertimbangkan scale up jika traffic terus naik
