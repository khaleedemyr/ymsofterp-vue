<!DOCTYPE html>
<html>
<head>
    <title>Test Session Safety</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; }
        .result { margin-top: 20px; padding: 10px; background: #f8f9fa; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <h1>Test Session Safety Fix</h1>
    
    <div class="test-section">
        <h2>Session Management Test</h2>
        <button onclick="testAddSession()">Test Add Session</button>
        <button onclick="testAddSessionItem()">Test Add Session Item</button>
        <button onclick="testCorruptedData()">Test Corrupted Data</button>
        <button onclick="resetForm()">Reset Form</button>
        <button onclick="showFormState()">Show Form State</button>
    </div>
    
    <div id="result" class="result" style="display: none;"></div>

    <script>
        // Simulate the form structure
        let form = {
            sessions: [
                {
                    order_number: 1,
                    session_title: 'Test Session 1',
                    items: [
                        {
                            order_number: 1,
                            item_type: 'material',
                            title: 'Test Item 1'
                        }
                    ]
                }
            ]
        };
        
        function log(message) {
            console.log(message);
        }
        
        function showResult(title, content, type = 'info') {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.innerHTML = `<h3>${title}</h3><div class="${type}">${content}</div>`;
        }
        
        // Session management methods with safety checks
        function addSession() {
            log('=== ADD SESSION STARTED ===');
            
            // Safety check: ensure sessions array exists
            if (!form.sessions || !Array.isArray(form.sessions)) {
                log('Sessions array is not initialized, creating default structure');
                form.sessions = [];
            }
            
            const maxOrder = Math.max(...form.sessions.map(s => s.order_number), 0);
            form.sessions.push({
                order_number: maxOrder + 1,
                session_title: '',
                items: []
            });
            
            log(`Session added successfully. Total sessions: ${form.sessions.length}`);
            return true;
        }
        
        function addSessionItem(sessionIndex) {
            log(`=== ADD SESSION ITEM STARTED (Session ${sessionIndex + 1}) ===`);
            
            // Safety check: ensure sessions array exists
            if (!form.sessions || !Array.isArray(form.sessions)) {
                log('Sessions array is not initialized');
                return false;
            }
            
            const session = form.sessions[sessionIndex];
            if (!session) {
                log(`Session at index ${sessionIndex} not found`);
                return false;
            }
            
            // Safety check: ensure items array exists
            if (!session.items || !Array.isArray(session.items)) {
                log(`Session ${sessionIndex} items array is not initialized, creating default structure`);
                session.items = [];
            }
            
            const maxOrder = Math.max(...session.items.map(item => item.order_number), 0);
            session.items.push({
                order_number: maxOrder + 1,
                item_type: '',
                title: ''
            });
            
            log(`Session item added to session ${sessionIndex + 1}. Total items: ${session.items.length}`);
            return true;
        }
        
        // Test functions
        function testAddSession() {
            log('Testing addSession function...');
            const result = addSession();
            if (result) {
                showResult('Add Session Test', 'Session added successfully!', 'success');
            } else {
                showResult('Add Session Test', 'Failed to add session!', 'error');
            }
        }
        
        function testAddSessionItem() {
            log('Testing addSessionItem function...');
            const result = addSessionItem(0);
            if (result) {
                showResult('Add Session Item Test', 'Session item added successfully!', 'success');
            } else {
                showResult('Add Session Item Test', 'Failed to add session item!', 'error');
            }
        }
        
        function testCorruptedData() {
            log('Testing with corrupted data...');
            
            // Corrupt the form data
            form.sessions = null;
            
            log('Attempting to add session with corrupted data...');
            const result = addSession();
            
            if (result) {
                showResult('Corrupted Data Test', 'Safety check worked! Form was repaired.', 'success');
            } else {
                showResult('Corrupted Data Test', 'Safety check failed!', 'error');
            }
        }
        
        function resetForm() {
            log('Resetting form to initial state...');
            form = {
                sessions: [
                    {
                        order_number: 1,
                        session_title: 'Test Session 1',
                        items: [
                            {
                                order_number: 1,
                                item_type: 'material',
                                title: 'Test Item 1'
                            }
                        ]
                    }
                ]
            };
            log('Form reset successfully');
            showResult('Reset Form', 'Form has been reset to initial state!', 'success');
        }
        
        function showFormState() {
            log('Showing current form state...');
            const formState = JSON.stringify(form, null, 2);
            showResult('Form State', `<pre>${formState}</pre>`, 'info');
        }
        
        // Initialize
        log('Session Safety Fix Test initialized');
        log(`Form has ${form.sessions.length} sessions`);
    </script>
</body>
</html>
