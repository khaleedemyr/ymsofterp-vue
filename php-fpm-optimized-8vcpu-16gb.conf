; ============================================
; PHP-FPM Configuration untuk Server 8 vCPU, 16GB RAM
; ============================================
; Optimized untuk Laravel application dengan high traffic
; ============================================

[www]
user = nobody
group = nobody
listen = /var/run/php-fpm/php-fpm.sock
listen.owner = nobody
listen.group = nobody
listen.mode = 0660

; ============================================
; Process Manager Settings
; ============================================
; Dynamic process manager - adjust based on load
pm = dynamic

; Max Children: (vCPU × 2) + overhead = (8 × 2) + 2 = 18
; Jangan lebih dari ini untuk prevent CPU overload
pm.max_children = 18

; Start dengan 50% dari max children
pm.start_servers = 9

; Minimum spare servers saat idle (30% dari max)
pm.min_spare_servers = 5

; Maximum spare servers saat idle (50% dari max)
pm.max_spare_servers = 9

; Max requests per process sebelum restart
; 50 cukup untuk prevent memory leak, tapi tidak terlalu sering restart
pm.max_requests = 50

; Process idle timeout - kill idle process setelah 10 detik
pm.process_idle_timeout = 10s

; ============================================
; Performance Tuning
; ============================================
; Enable status page untuk monitoring
pm.status_path = /php-fpm-status
ping.path = /php-fpm-ping

; ============================================
; Logging
; ============================================
; Access log
access.log = /var/log/php-fpm/access.log
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"

; Slow log - log request yang lebih dari 10 detik
slowlog = /var/log/php-fpm/slow.log
request_slowlog_timeout = 10s

; ============================================
; Security
; ============================================
; Hanya allow .php extension
security.limit_extensions = .php

; ============================================
; PHP Settings (Recommended untuk Laravel)
; ============================================
; Memory limit per process
php_admin_value[memory_limit] = 256M

; Max execution time
php_admin_value[max_execution_time] = 300

; Max input time
php_admin_value[max_input_time] = 300

; Upload max filesize
php_admin_value[upload_max_filesize] = 50M
php_admin_value[post_max_size] = 50M

; Error reporting (production: off, development: on)
php_admin_flag[display_errors] = off
php_admin_flag[log_errors] = on

; ============================================
; Opcache Settings (Recommended)
; ============================================
; Enable opcache untuk better performance
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 128
php_admin_value[opcache.interned_strings_buffer] = 16
php_admin_value[opcache.max_accelerated_files] = 10000
php_admin_value[opcache.revalidate_freq] = 2
php_admin_value[opcache.fast_shutdown] = 1

; ============================================
; Realpath Cache (Laravel Optimization)
; ============================================
php_admin_value[realpath_cache_size] = 4096K
php_admin_value[realpath_cache_ttl] = 600
